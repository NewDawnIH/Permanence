<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDoc - Documentation</title>
    <style>
        /* --- MATERIAL DESIGN 3 THEME & CSS VARIABLES --- */
       :root {
            /* Palette (Slate & Steel based) */
            --md-sys-color-primary: #334155; /* Deep Slate Blue */
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #eaddff; 
            --md-sys-color-on-primary-container: #f1f5f9;
            
            --md-sys-color-secondary: #475569; /* Cool Steel Gray */
            --md-sys-color-secondary-container: #cbd5e1;
            
            --md-sys-color-background: #f8fafc; /* Very light slate gray */
            --md-sys-color-on-background: #0f172a;
            
            --md-sys-color-surface: #ffffff; /* Card bg */
            --md-sys-color-surface-variant: #e2e8f0; /* Sidebar/Input bg - subtle gray */
            --md-sys-color-on-surface: #0f172a;
            --md-sys-color-on-surface-variant: #334155;
            
            --md-sys-color-outline: #94a3b8;
            --md-sys-color-outline-variant: #cbd5e1;
            --md-sys-color-error: #991b1b; /* Deep Crimson */

            /* Status Colors */
            --status-ana: #2563eb; /* Cobalt Blue */
            --status-dev: #b45309; /* Burnt Amber */
            --status-apb: #c2410c; /* Deep Rust Orange */
            --status-done: #15803d; /* Forest Green */

            /* Elevation & Shape */
            --md-sys-elevation-1: 0px 2px 4px 0px rgba(15, 23, 42, 0.1);
            --md-sys-elevation-2: 0px 8px 16px -4px rgba(15, 23, 42, 0.15);
            --md-sys-shape-corner-medium: 12px; 
            --md-sys-shape-corner-large: 16px;
            
            --font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            
            --statusbar-height: 52px;
            --statusbar-bg: rgba(255, 255, 255, 0.65);
            --statusbar-border: rgba(148, 163, 184, 0.4);
        }

        /* --- DARK THEME OVERRIDES --- */
        [data-theme="dark"] {
            --md-sys-color-primary: #94a3b8; /* Lighter slate */
            --md-sys-color-on-primary: #0f172a;
            --md-sys-color-primary-container: #334155;
            --md-sys-color-on-primary-container: #e2e8f0;

            --md-sys-color-secondary: #cbd5e1;
            --md-sys-color-secondary-container: #475569;

            --md-sys-color-background: #0f172a; /* Darkest slate */
            --md-sys-color-on-background: #f1f5f9;

            --md-sys-color-surface: #1e293b; /* Dark slate */
            --md-sys-color-surface-variant: #334155; /* Slightly lighter */
            --md-sys-color-on-surface: #f8fafc;
            --md-sys-color-on-surface-variant: #cbd5e1;

            --md-sys-color-outline: #64748b;
            --md-sys-color-outline-variant: #475569;
            
            --statusbar-bg: rgba(30, 41, 59, 0.8); /* Dark transparent */
            --statusbar-border: rgba(71, 85, 105, 0.5);
            
            /* Status tweaks for dark mode contrast */
            --status-ana: #60a5fa;
            --status-dev: #fb923c;
            --status-apb: #fb7185;
            --status-done: #4ade80;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
		/* --- Add this to your CSS --- */
		.query-box {
			background-color: #1e293b; /* Dark slate */
			color: #a5b4fc; /* Light indigo/blue text */
			font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
			font-size: 0.9rem;
			padding: 12px;
			border-radius: 6px;
			border: 1px solid #334155;
			margin: 8px 0;
			white-space: pre-wrap; /* Preserves newlines/spaces */
			overflow-x: auto;
			box-shadow: inset 0 1px 4px rgba(0,0,0,0.2);
		}

        /* --- STATUS BAR --- */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--statusbar-height);
            background-color: var(--statusbar-bg);
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--statusbar-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 1000;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--md-sys-color-on-surface);
        }

        .status-bar-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rec-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--md-sys-color-outline); 
            display: inline-block;
        }

        .rec-dot.active {
            background-color: #ef4444; /* Red */
            animation: pulse-red-dot 1.5s infinite;
        }

        @keyframes pulse-red-dot {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .status-btn-stop {
            background-color: var(--md-sys-color-error);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .status-metric {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--md-sys-color-secondary);
            font-size: 0.85rem;
        }

        .status-metric strong {
            color: var(--md-sys-color-primary);
        }

        /* --- LAYOUT FIXES FOR TRANSPARENCY --- */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background-color: var(--md-sys-color-surface-variant);
            padding: 1rem;
            padding-top: calc(var(--statusbar-height) + 1rem); 
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            border-right: 1px solid var(--md-sys-color-outline);
            z-index: 900; 
            height: 100%;
            transition: background-color 0.3s;
			overflow-y: auto;       /* Enables vertical scrolling */
			max-height: 100vh;      /* Ensures it doesn't grow beyond screen */
        }
		.sidebar::-webkit-scrollbar {
			width: 6px;
		}
		.sidebar::-webkit-scrollbar-track {
			background: transparent;
		}
		.sidebar::-webkit-scrollbar-thumb {
			background: var(--md-sys-color-outline);
			border-radius: 4px;
		}

        .brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 1rem;
            padding-left: 12px;
        }

        .nav-item {
            padding: 0 16px;
            height: 56px;
            display: flex;
            align-items: center;
            border-radius: 28px;
            cursor: pointer;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            transition: background 0.2s;
			flex-shrink: 0;
        }

        .nav-item:hover {
            background-color: rgba(100, 100, 100, 0.1);
        }

        .nav-item.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--md-sys-color-outline);
            padding-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            padding: 2rem;
            padding-top: calc(var(--statusbar-height) + 2rem);
            overflow-y: auto;
            position: relative;
            z-index: 1; 
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .page-title {
            font-size: 2rem;
            margin: 0;
            color: var(--md-sys-color-on-background);
        }

        /* --- DASHBOARD STYLES --- */
        
        /* Quick Links */
        .quick-link-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-link-card {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            user-select: none;
            text-decoration: none;
            color: var(--md-sys-color-on-surface);
            min-height: 120px;
            justify-content: center;
        }
        
        .quick-link-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--md-sys-elevation-2);
            border-color: var(--md-sys-color-primary);
        }

        .quick-link-icon {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
        }
        
        .quick-link-title {
            font-weight: bold;
            font-size: 1rem;
            color: var(--md-sys-color-primary);
        }
        
        .quick-link-desc {
            font-size: 0.8rem;
            color: var(--md-sys-color-secondary);
            margin-top: 4px;
        }

        .quick-link-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            cursor: pointer;
            padding: 4px;
            z-index: 10;
        }
        .quick-link-card:hover .quick-link-delete { opacity: 1; }

        .quick-link-add {
            border: 2px dashed var(--md-sys-color-outline-variant);
            background: transparent;
            color: var(--md-sys-color-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            cursor: pointer;
            border-radius: var(--md-sys-shape-corner-medium);
            transition: all 0.2s;
        }
        .quick-link-add:hover {
            border-color: var(--md-sys-color-primary);
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-primary);
        }

        /* Global To-Dos */
        .global-todo-container {
            margin-bottom: 2rem;
            background: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 1.5rem;
            box-shadow: var(--md-sys-elevation-1);
        }

        .todo-item-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            transition: background 0.2s;
        }
        .todo-item-row:hover { background: rgba(0,0,0,0.02); }
        .todo-item-row:last-child { border-bottom: none; }
        
        .todo-tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        .tag-project { 
            background: var(--md-sys-color-secondary-container); 
            color: var(--md-sys-color-on-secondary-container); 
            cursor: pointer;
        }
        
        .tag-global { 
            background: #fffbeb; 
            color: #b45309; 
            border: 1px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        [data-theme="dark"] .tag-global {
            background: #451a03;
            color: #fbbf24;
            border-color: #92400e;
        }

        .dashboard-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
            background: var(--md-sys-color-surface);
            padding: 1rem;
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-1);
        }

        .chart-wrapper {
            background: var(--md-sys-color-surface);
            padding: 2rem;
            border-radius: var(--md-sys-shape-corner-medium);
            box-shadow: var(--md-sys-elevation-1);
            margin-bottom: 2rem;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            color: var(--md-sys-color-on-surface);
        }

        .chart-container {
            flex: 1;
            display: flex;
            margin-top: 2rem;
            position: relative;
        }

        .chart-y-axis {
            display: flex;
            flex-direction: column-reverse;
            justify-content: space-between;
            padding-right: 1rem;
            border-right: 1px solid var(--md-sys-color-outline-variant);
            color: var(--md-sys-color-secondary);
            font-size: 0.8rem;
            height: 300px; 
        }

        .chart-area {
            flex: 1;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            height: 300px;
            padding-left: 1rem;
            position: relative;
        }

        .chart-grid-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--md-sys-color-outline-variant);
            opacity: 0.3;
            pointer-events: none;
        }

        .day-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 60px;
            height: 100%;
            justify-content: flex-end;
        }

        .bar-stack {
            width: 40px;
            display: flex;
            flex-direction: column-reverse; 
            border-radius: 4px 4px 0 0;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }
        
        .bar-stack:hover {
            transform: scaleX(1.1);
            z-index: 10;
        }

        .bar-segment {
            width: 100%;
            transition: height 0.5s ease-out;
            cursor: pointer;
            position: relative;
        }

        .bar-segment:hover { opacity: 0.8; }

        .bar-segment::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            display: none;
            z-index: 20;
            pointer-events: none;
        }

        .bar-segment:hover::after { display: block; }

        .day-label {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--md-sys-color-secondary);
        }

        /* Timeline / Daily View Styles */
        .timeline-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--md-sys-color-surface);
            border-radius: 8px;
            border-left: 4px solid var(--md-sys-color-outline);
            box-shadow: var(--md-sys-elevation-1);
        }

        .timeline-time {
            font-family: monospace;
            font-weight: bold;
            color: var(--md-sys-color-primary);
            min-width: 80px;
        }

        .timeline-content h4 { margin: 0 0 4px 0; color: var(--md-sys-color-on-surface); }
        .timeline-content p { margin: 0; color: var(--md-sys-color-on-surface-variant); font-size: 0.9rem; }

        .type-session { border-left-color: var(--status-ana); }
        .type-log { border-left-color: var(--status-dev); }
        .type-create { border-left-color: var(--status-done); }


        /* --- COMPONENTS --- */
        
        .btn {
            border: none;
            padding: 0 24px;
            height: 40px;
            border-radius: 20px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            transition: box-shadow 0.2s;
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        .btn-primary:hover { box-shadow: var(--md-sys-elevation-1); }

        .btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-outlined {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline);
            color: var(--md-sys-color-primary);
        }

        .btn-small { height: 32px; padding: 0 16px; font-size: 0.85rem; }
        .btn-icon-only { width: 32px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-danger { background-color: var(--md-sys-color-error); color: white; }
        .btn-success { background-color: var(--status-done); color: white; }

        /* Inputs */
        .input-group {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.75rem;
            color: var(--md-sys-color-primary);
            margin-bottom: 4px;
            font-weight: bold;
        }

        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            height: 56px;
            border-radius: 4px 4px 0 0;
            border: none;
            border-bottom: 1px solid var(--md-sys-color-outline);
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface);
            padding: 8px 16px;
            font-family: inherit;
            font-size: 1rem;
            width: 100%;
        }
        
        textarea { height: auto; min-height: 100px; padding-top: 16px; }
        input:focus, textarea:focus { outline: none; border-bottom: 2px solid var(--md-sys-color-primary); }

        /* Tables Page Design */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
            background: var(--md-sys-color-surface);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .data-table th {
            background: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            padding: 12px 16px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--md-sys-color-outline-variant);
        }

        .data-table td {
            padding: 8px 16px;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
            vertical-align: middle;
            color: var(--md-sys-color-on-surface);
        }

        .data-table tr:hover {
            background-color: var(--md-sys-color-surface-variant);
        }

        .table-inline-input {
            width: 100% !important;
            height: 36px !important;
            padding: 4px 8px !important;
            border-radius: 4px !important;
            border: 1px solid transparent !important;
            background: transparent !important;
            font-size: 0.9rem !important;
            color: var(--md-sys-color-on-surface) !important;
        }

        .table-inline-input:focus {
            background: var(--md-sys-color-surface-variant) !important;
            border-color: var(--md-sys-color-primary) !important;
            outline: none;
        }

        .filter-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            background: var(--md-sys-color-surface-variant);
            padding: 12px;
            border-radius: 8px;
        }

        .search-input {
            flex: 1;
            height: 40px !important;
            border-radius: 20px !important;
            border: 1px solid var(--md-sys-color-outline) !important;
            background: var(--md-sys-color-surface) !important;
            color: var(--md-sys-color-on-surface) !important;
        }

        /* Cards Grid */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .card {
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 1.5rem;
            box-shadow: var(--md-sys-elevation-1);
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            box-shadow: var(--md-sys-elevation-2);
            border-color: var(--md-sys-color-outline);
        }

        .card.query-update { border: 2px solid var(--md-sys-color-error); }
        .card.query-delete { background-color: var(--md-sys-color-error); color: #ffffff; }
        .card.query-delete h3, .card.query-delete p { color: #ffffff !important; }

        .card.project-card { border-left-width: 6px; border-left-style: solid; }
        .status-border-ANA { border-left-color: var(--status-ana) !important; }
        .status-border-DEV { border-left-color: var(--status-dev) !important; }
        .status-border-APB { border-left-color: var(--status-apb) !important; }
        .status-border-DONE { border-left-color: var(--status-done) !important; }
        .status-border-default { border-left-color: var(--md-sys-color-outline) !important; }

        .status-separator {
            grid-column: 1 / -1;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 2px solid var(--md-sys-color-outline-variant);
            color: var(--md-sys-color-primary);
            font-weight: bold;
            font-size: 1.1rem;
            padding-bottom: 0.2rem;
            display: flex;
            align-items: center;
        }
		/* --- PROGRAM TYPES --- */
        .prog-type-BATCH { border-left: 5px solid #673ab7 !important; } /* Purple */
        .prog-type-INTERACTIVE { border-left: 5px solid #06b6d4 !important; } /* Cyan */
        .prog-type-SERVICE { border-left: 5px solid #f97316 !important; } /* Orange */
        .prog-type-OTHER { border-left: 5px solid #94a3b8 !important; } /* Slate */

        .prog-type-tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 8px;
            color: white;
        }
        
        /* Reference Cards */
        .ref-card {
            background-color: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .ref-card:hover {
            border-color: var(--md-sys-color-primary);
            box-shadow: var(--md-sys-elevation-1);
        }

        .ref-card .ref-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ref-card .ref-title {
            font-weight: bold;
            color: var(--md-sys-color-primary);
            font-size: 1rem;
            cursor: pointer;
        }
        .ref-card .ref-title:hover { text-decoration: underline; }

        .ref-card .ref-desc {
            font-size: 0.85rem;
            color: var(--md-sys-color-on-surface-variant);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .card.active-timer {
            border: 2px solid var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            animation: pulse-border 2s infinite;
        }
        .card.active-timer p { color: var(--md-sys-color-on-primary-container); }

        @keyframes pulse-border {
            0% { border-color: var(--md-sys-color-primary); }
            50% { border-color: transparent; }
            100% { border-color: var(--md-sys-color-primary); }
        }

        .card h3 { margin: 0 0 0.5rem 0; font-size: 1.25rem; }
        .card p { margin: 0; color: var(--md-sys-color-on-surface-variant); font-size: 0.9rem; }
		/* --- FAVORITES STYLES --- */
        .card.is-favorite {
            border: 2px solid #fbbf24; /* Gold border */
            background: linear-gradient(135deg, var(--md-sys-color-surface) 0%, #fffbeb 100%);
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .card.is-favorite {
            background: linear-gradient(135deg, var(--md-sys-color-surface) 0%, #451a03 100%);
        }

        /* Shiny Animation Effect */
        .card.is-favorite::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            animation: shine 6s infinite ease-in-out;
            pointer-events: none;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            20% { transform: translateX(100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 5;
            color: var(--md-sys-color-outline);
            transition: transform 0.2s, color 0.2s;
            background: transparent;
            border: none;
        }
        
        .favorite-btn:hover { transform: scale(1.2); }
        .favorite-btn.active { color: #fbbf24; text-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }
        
        .favorites-header {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 1rem;
            color: #b45309;
            border-bottom: 2px solid #fbbf24;
            padding-bottom: 8px;
            font-weight: bold;
        }
        [data-theme="dark"] .favorites-header { color: #fbbf24; }

        /* Detail View Styles */
        .detail-container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--md-sys-color-surface);
            padding: 2rem;
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-1);
            position: relative;
            color: var(--md-sys-color-on-surface);
        }

        .section-header {
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--md-sys-color-outline);
            padding-bottom: 0.5rem;
            color: var(--md-sys-color-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modals */
        dialog {
            border: none;
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-2);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }
        
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }

        /* Chips / Status */
        .chip {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-transform: uppercase;
        }
        .status-ANA { background-color: var(--status-ana); }
        .status-DEV { background-color: var(--status-dev); }
        .status-APB { background-color: var(--status-apb); }
        .status-DONE { background-color: var(--status-done); }

        .chip-keyword {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            margin: 2px;
            cursor: default;
        }
        .chip-removable { cursor: pointer; padding-right: 8px; }
        .chip-removable:hover { background-color: #d0bcff; }

        /* Status Slider */
        .status-slider-container {
            width: 100%;
            margin-top: 8px;
            position: relative;
        }
        
        .status-slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            font-weight: bold;
            color: var(--md-sys-color-primary);
            margin-bottom: 2px;
            pointer-events: none;
        }

        input[type=range].status-slider {
            width: 100%;
            -webkit-appearance: none;
            background: transparent;
            cursor: pointer;
            height: 24px;
            margin: 0;
            padding: 0;
            border: none;
        }
		/* --- MERGE PANEL STYLES --- */
		.merge-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
			gap: 1rem;
			margin-bottom: 2rem;
		}

		.merge-config-card {
			background: var(--md-sys-color-surface);
			border: 1px solid var(--md-sys-color-outline-variant);
			padding: 1rem;
			border-radius: 8px;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.merge-checkbox-wrapper {
			display: flex;
			align-items: center;
			gap: 8px;
			cursor: pointer;
		}

		.merge-checkbox-wrapper input[type="checkbox"] {
			width: 18px; 
			height: 18px; 
			accent-color: var(--md-sys-color-primary);
			cursor: pointer;
		}

		/* Success Animation Overlay */
		#successOverlay {
			position: fixed;
			top: 0; left: 0; width: 100%; height: 100%;
			background: rgba(0,0,0,0.7);
			z-index: 2000;
			display: none;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			color: white;
			backdrop-filter: blur(5px);
		}

		.checkmark-circle {
			width: 100px; height: 100px;
			border-radius: 50%;
			background: var(--status-done);
			display: flex; justify-content: center; align-items: center;
			box-shadow: 0 0 20px var(--status-done);
			animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
		}

		.checkmark {
			font-size: 60px; font-weight: bold; color: white;
		}

		.success-text {
			margin-top: 20px; font-size: 1.5rem; font-weight: bold;
			opacity: 0;
			animation: fadeIn 0.5s ease 0.3s forwards;
		}

		@keyframes popIn {
			0% { transform: scale(0); }
			80% { transform: scale(1.2); }
			100% { transform: scale(1); }
		}
		@keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        /* Thumb */
        input[type=range].status-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--md-sys-color-primary);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: background 0.2s;
        }
        
        /* Track */
        input[type=range].status-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: var(--md-sys-color-outline-variant);
            border-radius: 2px;
        }

        .dynamic-list-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: start;
            background: var(--md-sys-color-surface-variant);
            padding: 10px;
            border-radius: 8px;
        }
        .smart-link {
            color: var(--md-sys-color-primary);
            text-decoration: underline;
            cursor: pointer;
            margin-left: 8px;
            font-weight: bold;
        }

        .timer-display {
            font-size: 3.5rem;
            font-family: monospace;
            text-align: center;
            margin: 1rem 0;
            color: var(--md-sys-color-primary);
            font-weight: bold;
        }

        .todo-card {
            background: var(--md-sys-color-surface-variant);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .todo-card:hover { border-color: var(--md-sys-color-outline-variant); }
        .todo-card.done { opacity: 0.6; }
        .todo-card input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        .work-log-entry {
            border-left: 3px solid var(--md-sys-color-outline-variant);
            padding-left: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
        }
        .work-log-meta {
            font-size: 0.75rem;
            color: var(--md-sys-color-secondary);
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 10px;
        }
        .work-log-content {
            font-size: 0.95rem;
            line-height: 1.5;
            white-space: pre-wrap;
            color: var(--md-sys-color-on-surface);
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .work-log-entry.important {
            border-left-color: var(--md-sys-color-error);
            border: 2px solid var(--md-sys-color-error);
            border-radius: 8px;
            padding: 10px;
            animation: pulse-red 2s infinite;
        }

        .log-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.2s;
            margin-left: 8px;
            font-size: 1rem;
            color: var(--md-sys-color-on-surface);
        }
        .log-action-btn:hover { opacity: 1; transform: scale(1.1); }
        .log-action-btn.active-star { color: var(--md-sys-color-error); opacity: 1; }
        
        .smart-ref {
            display: inline-block;
            padding: 0 6px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
            margin: 0 2px;
            vertical-align: baseline;
            cursor: default;
        }
        .smart-ref.found {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            cursor: pointer;
            border: 1px solid transparent;
        }
        .smart-ref.found:hover {
            border-color: var(--md-sys-color-primary);
        }
        .smart-ref.missing {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px dashed #b91c1c;
        }
		/* --- FIXED TICKETS STYLES --- */
        .fixed-ticket-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--md-sys-color-surface-variant);
            padding: 1rem;
            border-radius: 16px;
        }

        .fixed-ticket-card {
            background: var(--md-sys-color-surface);
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100px;
            position: relative;
            border-left: 5px solid var(--md-sys-color-secondary);
        }

        .fixed-ticket-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--md-sys-elevation-2);
            border-color: var(--md-sys-color-primary);
        }

        .fixed-ticket-card.active-timer {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            border-color: var(--md-sys-color-primary);
        }
        
        /* Adjust text colors when active */
        .fixed-ticket-card.active-timer h3, 
        .fixed-ticket-card.active-timer p,
        .fixed-ticket-card.active-timer .btn-icon-only {
            color: var(--md-sys-color-on-primary) !important;
        }

        .fixed-ticket-title {
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fixed-ticket-time {
            font-family: monospace;
            font-size: 1.2rem;
            margin-top: 8px;
            font-weight: bold;
        }

        .fixed-ticket-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0.7;
        }
        .fixed-ticket-card:hover .fixed-ticket-actions { opacity: 1; }
        /* --- SMART LINK WIDGET STYLES --- */
		.link-widget-wrapper {
			position: relative;
			height: 100%; /* Ensure consistent height in grid */
		}

		/* The Card Look */
		.link-card-display {
			background: var(--md-sys-color-surface);
			border: 1px solid var(--md-sys-color-outline-variant);
			border-left: 4px solid var(--md-sys-color-secondary); /* Default Accent */
			border-radius: 8px;
			padding: 12px;
			display: flex;
			align-items: center;
			gap: 12px;
			cursor: pointer;
			transition: all 0.2s ease;
			height: 60px; /* Fixed height for neatness */
			max-width: 100%;
		}

		.link-card-display:hover {
			transform: translateY(-2px);
			box-shadow: var(--md-sys-elevation-1);
			border-color: var(--md-sys-color-primary);
		}

		/* Specific Colors for Types */
		.card-type-linkDOR { border-left-color: #3b82f6; } /* Blue */
		.card-type-linkDOD { border-left-color: #22c55e; } /* Green */
		.card-type-linkOther { border-left-color: #a855f7; } /* Purple */

		.link-card-content {
			flex: 1;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			justify-content: center;
			min-width: 0;
		}

		.link-card-label {
			font-size: 0.65rem;
			text-transform: uppercase;
			color: var(--md-sys-color-secondary);
			font-weight: bold;
			letter-spacing: 0.5px;
		}

		.link-card-url {
			font-size: 0.9rem;
			font-weight: 500;
			color: var(--md-sys-color-on-surface);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			/* Truncation Logic */
			display: block; /* Ensures max-width logic applies */
		}

		/* Edit Button (Visible on Hover) */
		.link-card-actions {
			opacity: 0; 
			transition: opacity 0.2s;
		}
		.link-card-display:hover .link-card-actions {
			opacity: 1;
		}

		/* The Input State */
		.link-input-state {
			display: flex;
			flex-direction: column;
		}
		.link-input-state input {
			font-size: 0.9rem;
			border-bottom-width: 2px;
		}
		.link-input-anim {
			animation: fadeIn 0.3s ease;
		}
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0px 4px 10px rgba(0,0,0,0.3);
            font-size: 0.9rem;
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
		/* --- NEW FEATURE: OMNI SEARCH (COMMAND PALETTE) --- */
		.omni-backdrop {
			position: fixed; top: 0; left: 0; width: 100%; height: 100%;
			background: rgba(0,0,0,0.6); z-index: 5000;
			display: none; align-items: flex-start; justify-content: center;
			padding-top: 80px; backdrop-filter: blur(3px);
		}
		.omni-box {
			width: 600px; max-width: 90%;
			background: var(--md-sys-color-surface);
			border-radius: 12px;
			border: 1px solid var(--md-sys-color-outline-variant);
			box-shadow: 0 20px 50px rgba(0,0,0,0.4);
			display: flex; flex-direction: column; overflow: hidden;
			animation: slideDown 0.15s ease-out;
		}
		@keyframes slideDown { from {transform: translateY(-20px); opacity:0;} to {transform: translateY(0); opacity:1;} }

		.omni-input {
			width: 100%; padding: 16px 20px; font-size: 1.2rem; border: none;
			border-bottom: 1px solid var(--md-sys-color-outline-variant);
			background: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface);
			outline: none; font-family: var(--font-family);
		}
		.omni-results {
			max-height: 400px; overflow-y: auto;
		}
		.omni-item {
			padding: 12px 20px; border-bottom: 1px solid var(--md-sys-color-outline-variant);
			cursor: pointer; display: flex; align-items: center; gap: 12px;
			transition: background 0.1s;
		}
		.omni-item:hover, .omni-item.selected { background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); }
		.omni-type {
			font-size: 0.7rem; text-transform: uppercase; font-weight: bold;
			padding: 4px 8px; border-radius: 4px; color: white; min-width: 70px; text-align: center;
		}
		/* Omni-Type Colors */
		.omni-type.PROG { background: #673ab7; }
		.omni-type.TAB { background: #06b6d4; }
		.omni-type.QRY { background: #f97316; }
		.omni-type.PROJ { background: #22c55e; }
		.omni-type.MAIL { background: #e11d48; }

		.omni-footer {
			padding: 8px 16px; font-size: 0.75rem; 
			color: var(--md-sys-color-secondary); 
			background: var(--md-sys-color-surface-variant); 
			border-top: 1px solid var(--md-sys-color-outline-variant);
			display: flex; justify-content: space-between;
		}

		/* --- NEW FEATURE: ERD VISUALIZER --- */
		.erd-container {
			background: var(--md-sys-color-surface-variant);
			border: 1px solid var(--md-sys-color-outline-variant);
			border-radius: 8px; overflow: hidden;
			position: relative; height: calc(100vh - 200px); width: 100%;
			cursor: grab;
			background-image: radial-gradient(var(--md-sys-color-outline-variant) 1px, transparent 1px);
			background-size: 20px 20px; /* Dot grid effect */
		}
		.erd-container:active { cursor: grabbing; }
		
    </style>
</head>
<body>

<!-- GLOBAL STATUS BAR -->
<div class="status-bar" id="globalStatusBar">
    <div class="status-bar-section" id="sb-timer-section">
        <!-- Content injected via JS -->
    </div>
    
    <div class="status-bar-section">
        <div class="status-metric" title="Open Todos">
            <span style="font-size: 1.1em;">üìù</span>
            <span id="sb-todo-count">0 Open</span>
        </div>
    </div>

    <div class="status-bar-section">
        <div class="status-metric">
            <span>Last Save:</span>
            <strong id="sb-last-save">Never</strong>
        </div>
        <button class="btn btn-icon-only btn-tonal" id="themeToggleBtn" onclick="app.toggleTheme()" title="Toggle Dark Theme" style="margin-left: 8px;">
            üåô
        </button>
    </div>
</div>

<div class="app-container">
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="brand">MDoc</div>
		<div class="nav-item" onclick="router.navigate('dashboard')">üìä Dashboard</div>
	    <div class="nav-item" onclick="router.navigate('projects')">üóÇÔ∏è Projects</div>
        <div class="nav-item" onclick="router.navigate('programs')">üì¶ Programs</div>
        <div class="nav-item" onclick="router.navigate('tables')">üõ¢Ô∏è Tables</div>
		<div class="nav-item" onclick="router.navigate('erd')" style="padding-left: 40px; font-size: 0.9em; height: 40px; opacity: 0.8;">‚Ü≥ üï∏Ô∏è Visualizer</div>
        <div class="nav-item" onclick="router.navigate('queries')">üîç Queries</div>
        <div class="nav-item" onclick="router.navigate('mailbox')">üì¨ Mailbox</div>
		<div class="nav-item" onclick="router.navigate('orphans')">üëª Orphan Objects</div>
		<div class="nav-item" onclick="router.navigate('confluence')">üìÑ Confluence</div>
		<div class="nav-item" onclick="router.navigate('merge')">üîÑ Merge Data</div>
        <div class="nav-item" onclick="router.navigate('logwork')">‚åõ Log Work</div>

        <div class="sidebar-footer">
            <button class="btn btn-outlined btn-small" onclick="app.copyToClipboard()">Copy JSON (Clipboard)</button>
            <button class="btn btn-outlined btn-small" onclick="app.saveToFile()">Save (Export JSON)</button>
            <button class="btn btn-outlined btn-small" onclick="document.getElementById('fileInput').click()">Load (Import JSON)</button>
            <input type="file" id="fileInput" style="display:none" onchange="app.loadFromFile(this)">
            <small style="text-align: center; color: var(--md-sys-color-on-surface-variant)">Documentation System Beta</small>
        </div>
    </nav>

    <!-- MAIN AREA -->
    <main class="main-content" id="mainContent">
        <!-- Dynamic Content Injected Here -->
    </main>
</div>
<div id="omniSearchModal" class="omni-backdrop" onclick="if(event.target===this) ui.closeOmniSearch()">
    <div class="omni-box">
        <input type="text" id="omniInput" class="omni-input" placeholder="Search projects, tables, logic..." autocomplete="off">
        <div id="omniResults" class="omni-results"></div>
        <div class="omni-footer">
            <span><strong>‚Üë‚Üì</strong> to navigate</span> 
            <span><strong>Enter</strong> to select</span> 
            <span><strong>Esc</strong> to close</span>
        </div>
    </div>
</div>
<!-- CREATE MODAL TEMPLATE -->
<dialog id="createModal">
    <h2 id="modalTitle">Create New</h2>
    <form id="modalForm" method="dialog">
        <div id="modalInputs"></div>
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-outlined" onclick="document.getElementById('createModal').close()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create</button>
        </div>
    </form>
</dialog>

<!-- FIELD DETAILS MODAL -->
<dialog id="fieldModal">
    <h2>Field Details</h2>
    <form id="fieldForm" method="dialog">
        <input type="hidden" name="tableId" id="fieldTableId">
        <input type="hidden" name="fieldIndex" id="fieldIndex">
        
        <div class="input-group">
            <label>Name</label>
            <input type="text" name="name" id="fieldName" required>
        </div>
        <div class="input-group">
            <label>Description</label>
            <textarea name="desc" id="fieldDesc"></textarea>
        </div>
        <div class="input-group">
            <label>Example Value</label>
            <input type="text" name="ex" id="fieldEx">
        </div>
        <div class="input-group">
            <label>Comment / Technical Note</label>
            <textarea name="comm" id="fieldComm"></textarea>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
            <button type="button" class="btn btn-outlined" onclick="document.getElementById('fieldModal').close()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
    </form>
</dialog>

<!-- ADJUST TIME MODAL (FIXED) -->
<dialog id="adjustTimeModal">
    <h2>Adjust Time</h2>
    <p style="margin-top: -10px; opacity: 0.7; font-size: 0.9rem;">Enter duration in format HH:MM:SS (e.g., 1:30:00) or just Minutes (e.g., 90).</p>
    
    <div class="input-group">
        <label>Time / Duration</label>
        <input type="text" id="adjustTimeInput" placeholder="e.g. 1:30 or 60" autofocus>
    </div>

    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-tonal" style="flex:1" onclick="ui.confirmAdjust('add')">+ Add</button>
            <button class="btn btn-tonal" style="flex:1" onclick="ui.confirmAdjust('sub')">- Subtract</button>
        </div>
        <button class="btn btn-outlined" onclick="ui.confirmAdjust('set')">= Set Total</button>
        <button class="btn btn-danger" style="margin-top: 10px;" onclick="document.getElementById('adjustTimeModal').close()">Cancel</button>
    </div>
</dialog>

<!-- TABLE LINK MODAL -->
<dialog id="linkModal">
    <h2>Add Table Link</h2>
    <form id="linkForm" method="dialog">
        <input type="hidden" name="fromTableId" id="linkFromTableId">
        
        <div class="input-group">
            <label>Table From</label>
            <input type="text" id="linkFromTableName" disabled style="opacity: 0.7;">
        </div>
        
        <div class="input-group">
            <label>Table To (Select or Type New)</label>
            <input type="text" name="toTable" id="linkToTableInput" list="tableSuggestions" required autocomplete="off" placeholder="Type table name...">
            <datalist id="tableSuggestions"></datalist>
        </div>
        
        <div class="input-group">
            <label>Join Statement</label>
            <textarea name="joinStatement" placeholder="e.g. T1.customer_id = T2.id" style="min-height: 80px;"></textarea>
        </div>
        
        <div style="margin-bottom: 2rem; display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--md-sys-color-surface-variant); border-radius: 8px;">
            <input type="checkbox" name="bidirectional" id="linkBidirectional" style="width: 20px; height: 20px; cursor: pointer;">
            <div>
                <label for="linkBidirectional" style="margin:0; font-size: 1rem; cursor:pointer; color: var(--md-sys-color-on-surface);">Bi-directional Link</label>
                <div style="font-size: 0.75rem; color: var(--md-sys-color-secondary);">If checked, this link will also appear on the target table.</div>
            </div>
        </div>
        
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button type="button" class="btn btn-outlined" onclick="document.getElementById('linkModal').close()">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Link</button>
        </div>
    </form>
</dialog>

<!-- NEW: DELETE CONFIRMATION MODAL -->
<dialog id="deleteConfirmModal">
    <h2>Confirm Action</h2>
    <p>Are you sure you want to remove this quick link?</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button class="btn btn-outlined" onclick="document.getElementById('deleteConfirmModal').close()">Cancel</button>
        <button class="btn btn-danger" onclick="ui.performDeleteQuickLink()">Confirm Removal</button>
    </div>
</dialog>

<!-- NEW: ADD REMINDER MODAL -->
<dialog id="reminderModal">
    <h2>Create Reminder</h2>
    <div class="input-group">
        <label>Reminder Text</label>
        <input type="text" id="remText" placeholder="What to remember?">
    </div>
    <div class="input-group">
        <label>Date</label>
        <input type="date" id="remDate">
    </div>
    <div class="input-group">
        <label>Time</label>
        <input type="time" id="remTime">
    </div>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button class="btn btn-outlined" onclick="document.getElementById('reminderModal').close()">Cancel</button>
        <button class="btn btn-primary" onclick="ui.saveReminder()">Set Reminder</button>
    </div>
</dialog>

<!-- NEW: REMINDER ALERT MODAL -->
<dialog id="reminderAlertModal" style="border-left: 6px solid var(--md-sys-color-primary);">
    <h2 style="color:var(--md-sys-color-primary)">‚è∞ Reminder Due</h2>
    <p id="reminderAlertText" style="font-size: 1.2rem; margin: 1.5rem 0; font-weight: 500;"></p>
    <div style="display: flex; justify-content: flex-end;">
        <button class="btn btn-primary" onclick="ui.dismissCurrentReminder()">Dismiss</button>
    </div>
</dialog>
<dialog id="systemLogModal">
    <h2>‚è±Ô∏è Work Session Complete</h2>
    <p>Please describe the work done for <strong id="sysLogTitle"></strong>:</p>
    
    <div class="input-group">
        <label>Description / Activity</label>
        <textarea id="sysLogInput" placeholder="e.g. Fixed crash in module X..." style="min-height: 100px;"></textarea>
    </div>

    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button class="btn btn-primary" onclick="ui.confirmSystemStop()">Save & Stop</button>
    </div>
</dialog>
<dialog id="mergeConfirmModal">
    <h2>Confirm Merge</h2>
    <p>You are about to merge external data into your system.</p>
    <ul id="mergeSummary" style="background: var(--md-sys-color-surface-variant); padding: 10px 20px; border-radius: 8px; margin: 10px 0;"></ul>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button class="btn btn-outlined" onclick="document.getElementById('mergeConfirmModal').close()">Cancel</button>
        <button class="btn btn-primary" onclick="ui.executeMerge()">Confirm & Merge</button>
    </div>
</dialog>

<div id="successOverlay">
    <div class="checkmark-circle">
        <div class="checkmark">‚úì</div>
    </div>
    <div class="success-text">Merge Successful!</div>
</div>

<!-- Toast -->
<div id="toast">JSON copied to clipboard!</div>

<script>
/**
 * --- MERGE PANEL RENDERER ---
 */
function renderMergePanel() {
    const mainEl = document.getElementById('mainContent');
    const types = [
        { id: 'programs', label: 'Programs' },
        { id: 'tables', label: 'Tables' },
        { id: 'queries', label: 'Queries' },
        { id: 'projects', label: 'Projects' },
        { id: 'mailbox', label: 'Mailbox' }
    ];

    let html = `
        <div class="header-row">
            <h1 class="page-title">Merge Data</h1>
        </div>
        
        <div style="display: flex; gap: 2rem; height: calc(100vh - 160px);">
            <div style="flex: 1; display: flex; flex-direction: column;">
                <h3 style="color: var(--md-sys-color-primary);">1. Paste Foreign JSON</h3>
                <textarea id="mergeInput" placeholder="Paste the full JSON content here..." 
                    style="flex: 1; width: 100%; border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.9rem; resize: none;"></textarea>
            </div>

            <div style="flex: 1; display: flex; flex-direction: column;">
                <h3 style="color: var(--md-sys-color-primary);">2. Configuration</h3>
                
                <div class="merge-grid">
                    ${types.map(t => `
                        <div class="merge-config-card">
                            <span style="font-weight: bold;">${t.label}</span>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <label class="merge-checkbox-wrapper">
                                    <input type="checkbox" id="load_${t.id}" checked> Load
                                </label>
                                <label class="merge-checkbox-wrapper">
                                    <input type="checkbox" id="over_${t.id}"> Overwrite Own
                                </label>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div style="margin-top: auto; background: var(--md-sys-color-surface-variant); padding: 1.5rem; border-radius: 8px;">
                    <label class="merge-checkbox-wrapper" style="margin-bottom: 1rem; font-weight: bold; font-size: 1.1rem;">
                        <input type="checkbox" id="backupFirst" checked> 
                        üíæ Save backup of own JSON first
                    </label>
                    
                    <button class="btn btn-primary" style="width: 100%; height: 50px; font-size: 1.1rem;" onclick="ui.initMerge()">
                        Start Merge Process
                    </button>
                </div>
            </div>
        </div>
    `;

    mainEl.innerHTML = html;
}


/**
 * --- UTILS ---
 */
 /**
 * --- PROGRAM UTILS ---
 */
// Global state for program filter
let currentProgramFilter = 'ALL'; 

function getProgramType(name) {
    if (!name) return 'OTHER';
    const n = name.toUpperCase().trim();
    
    if (n.startsWith('SRV') || n.startsWith('SVL')) return 'SERVICE';
    if (n.endsWith('B')) return 'BATCH';
    if (n.endsWith('I')) return 'INTERACTIVE';
    return 'OTHER';
}
function formatDuration(ms) {
    const totalSeconds = Math.floor((ms || 0) / 1000);
    
    // Define the custom day length (7h 24m) in seconds
    const secondsInWorkDay = (7 * 3600) + (24 * 60); // 26640 seconds
    
    // Calculate days based on custom length
    const days = Math.floor(totalSeconds / secondsInWorkDay);
    
    // Calculate remaining time within that "day"
    const remainingSeconds = totalSeconds % secondsInWorkDay;
    
    const hours = Math.floor(remainingSeconds / 3600);
    const minutes = Math.floor((remainingSeconds % 3600) / 60);
    const seconds = remainingSeconds % 60;
    
    const pad = (num) => num.toString().padStart(2, '0');
    
    if (days > 0) {
        // Returns "DD - HH:MM:SS"
        // Note: HH will never exceed 07 in this logic because of the modulo
        return `${pad(days)}d - ${pad(hours)}h:${pad(minutes)}m:${pad(seconds)}s`;
    } else {
        return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
    }
}

/**
 * --- DATA STORE & LOGIC ---
 */
class DataStore {
    constructor() {
        this.data = {
            programs: [],
            tables: [],
            queries: [],
            projects: [],
            mailbox: [],
            workSessions: [],
            quickLinks: [], 
            globalTodos: [],
            reminders: [] // New
        };
        this.loadFromLocalStorage();
    }

    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    ensureSystemProjects() {
        if (!this.data.projects) this.data.projects = [];

        const systemTickets = [
            { id: 'mailbox_fixed', name: 'Mailbox Support', desc: 'Support requests and mailbox maintenance.' },
            { id: 'incident_fixed', name: 'Incident Management', desc: 'Urgent fixes and production incidents.' },
            { id: 'overhead_fixed', name: 'Overhead', desc: 'Meetings, admin, and general overhead.' }
        ];

        systemTickets.forEach(ticket => {
            const exists = this.data.projects.find(p => p.id === ticket.id);
            if (!exists) {
                this.data.projects.unshift({
                    id: ticket.id,
                    name: ticket.name,
                    description: ticket.desc,
                    status: 'ANA', // Keeps it active
                    timeSpent: 0,
                    workLog: [],
                    isSystem: true
                });
            }
        });
        this.save();
    }
    // CRUD
    add(type, item) {
        item.id = this.generateId();
        item.createdAt = new Date().toISOString();
        if(type === 'projects') item.timeSpent = 0; // Initialize time
        this.data[type].push(item);
        this.save();
        return item;
    }

    update(type, id, updates) {
        const idx = this.data[type].findIndex(x => x.id === id);
        if (idx !== -1) {
            this.data[type][idx] = { ...this.data[type][idx], ...updates };
            this.save();
        }
    }

    delete(type, id) {
        // Prevent deleting system objects
        if (id === 'mailbox_fixed' || id === 'incident_fixed' || id === 'overhead_fixed') {
            alert("Cannot delete the system Mailbox card.");
            return;
        }

        const idx = this.data[type].findIndex(x => x.id === id);
        if (idx !== -1) {
            this.data[type].splice(idx, 1);
            this.save();
        }
    }

    get(type, id) {
        return this.data[type].find(x => x.id === id);
    }

    getAll(type) {
        return this.data[type] || [];
    }

    // Inside class DataStore
	findByName(type, name) {
		if (!name) return null;
		return this.data[type].find(x => {
			// Updated to include 'subject' for Mailbox
			const itemName = x.name || x.shortName || x.subject || '';
			return itemName.toLowerCase() === name.toLowerCase();
		});
	}

    // Persistence
    save() {
        localStorage.setItem('devManagerData', JSON.stringify(this.data));
    }

    loadFromLocalStorage() {
        const stored = localStorage.getItem('devManagerData');
        if (stored) {
            this.data = JSON.parse(stored);
        }
        if(!this.data.mailbox) this.data.mailbox = [];
        if(!this.data.workSessions) this.data.workSessions = [];
        if(!this.data.quickLinks) this.data.quickLinks = [];
        if(!this.data.globalTodos) this.data.globalTodos = [];
        if(!this.data.reminders) this.data.reminders = []; // Ensure reminders array
        this.ensureSystemProjects();
    }

    importData(jsonString) {
        try {
            this.data = JSON.parse(jsonString);
            if(!this.data.mailbox) this.data.mailbox = [];
            if(!this.data.workSessions) this.data.workSessions = [];
            if(!this.data.quickLinks) this.data.quickLinks = [];
            if(!this.data.globalTodos) this.data.globalTodos = [];
            if(!this.data.reminders) this.data.reminders = [];
            this.ensureSystemProjects();
            this.save();
            alert('Data loaded successfully!');
            location.reload();
        } catch (e) {
            alert('Invalid JSON file.');
        }
    }
}

const store = new DataStore();

/**
 * --- ROUTER & VIEW MANAGER ---
 */
class Router {
    constructor() {
        this.currentView = 'programs';
        this.mainEl = document.getElementById('mainContent');
        this.navItems = document.querySelectorAll('.nav-item');
        this.searchState = {}; // Stores search queries per view
        this.dashboardDate = null; // null = Week View, Date String = Daily View
    }

    navigate(view, id = null) {
		this.currentView = view;

		this.navItems.forEach(el => el.classList.remove('active'));
		// Logic to highlight 'Tables' parent if ERD is selected
		const searchView = view === 'erd' ? 'tables' : view;
		const activeNav = Array.from(this.navItems).find(el => el.innerText.toLowerCase().replace(' ', '').includes(searchView));
		if(activeNav) activeNav.classList.add('active');

		// --- NEW ROUTE ---
		if (view === 'erd') { renderERDView(); return; }
		// -----------------

		if (id) {
			this.renderDetail(view, id);
		} else {
			this.renderList(view);
		}
	}

    renderList(type) {
        if (type === 'logwork') { renderLogWork(); return; }
        if (type === 'dashboard') { renderDashboard(); return; }
        if (type === 'orphans') { renderOrphanList(); return; }
        if (type === 'confluence') { renderConfluencePanel(); return; }
		if (type === 'merge') { renderMergePanel(); return; }
        
        const items = store.getAll(type);
        const titleMap = { programs: 'Programs', tables: 'Tables', queries: 'Queries', projects: 'Projects', mailbox: 'Mailbox' };
        
        // --- SEARCH ---
        const currentSearch = this.searchState[type] || '';
        let filteredItems = items.filter(item => {
            if (type === 'projects' && (item.id === 'mailbox_fixed' || item.id === 'incident_fixed' || item.id === 'overhead_fixed')) return false;
            const raw = JSON.stringify(item).toLowerCase();
            return raw.includes(currentSearch.toLowerCase());
        });

        // --- NEW: PROGRAM TYPE FILTER ---
        if (type === 'programs') {
            if (typeof currentProgramFilter === 'undefined') currentProgramFilter = 'ALL';
            
            if (currentProgramFilter !== 'ALL') {
                filteredItems = filteredItems.filter(item => {
                    // Check Short Name (usually the technical name) or Name
                    const nameToCheck = item.shortName || item.name || '';
                    return getProgramType(nameToCheck) === currentProgramFilter;
                });
            }
        }

        // --- SPLIT FAVORITES ---
        const supportsFavorites = ['programs', 'tables', 'queries', 'projects'].includes(type);
        
        let favorites = [];
        let others = filteredItems;

        if (supportsFavorites) {
            favorites = filteredItems.filter(i => i.favorite);
            others = filteredItems.filter(i => !i.favorite);
        }

        let html = `
            <div class="header-row">
                <h1 class="page-title">${titleMap[type]}</h1>
                <button class="btn btn-primary" onclick="ui.openCreateModal('${type}')">
                    + New ${titleMap[type].replace('Mailbox', 'Mail/Issue').slice(0, type === 'mailbox' ? 10 : -1)}
                </button>
            </div>
            
            <div class="filter-bar" style="margin-bottom: 1.5rem;">
                <span style="font-size: 1.2rem;">üîé</span>
                <input type="text" class="search-input" placeholder="Search ${titleMap[type]}..." 
                    value="${currentSearch}" 
                    oninput="router.searchState['${type}'] = this.value; router.renderList('${type}')" 
                    autofocus>
            </div>
        `;

        // --- NEW: INSERT FILTER BUTTONS FOR PROGRAMS ---
        if (type === 'programs') {
            const types = ['ALL', 'BATCH', 'INTERACTIVE', 'SERVICE', 'OTHER'];
            html += `<div style="display:flex; gap:8px; margin-bottom: 1.5rem; flex-wrap: wrap;">`;
            types.forEach(t => {
                const isActive = currentProgramFilter === t;
                const btnClass = isActive ? 'btn-primary' : 'btn-outlined';
                html += `<button class="btn ${btnClass} btn-small" onclick="currentProgramFilter='${t}'; router.renderList('programs')">${t}</button>`;
            });
            html += `</div>`;
        }

        if (type === 'mailbox') {
            // ... (Keep existing Mailbox Logic unchanged) ...
            // Copy your existing Mailbox logic here from previous version
            const openItems = filteredItems.filter(i => i.status !== 'Solved');
            const solvedItems = filteredItems.filter(i => i.status === 'Solved');

            html += `<h3 style="color:var(--md-sys-color-primary)">Open Issues</h3><div class="card-grid">`;
            if(openItems.length === 0) html += `<p style="grid-column: 1/-1; opacity:0.6">No open mail items.</p>`;
            openItems.forEach(item => {
                const keywordsHtml = (item.keywords || []).map(k => `<span class="chip chip-keyword">${k}</span>`).join('');
                html += `
                    <div class="card" onclick="router.navigate('mailbox', '${item.id}')" style="border-left: 6px solid var(--md-sys-color-primary)">
                        <h3 style="margin:0">${item.subject}</h3>
                        <div style="font-size:0.8rem; color:var(--md-sys-color-secondary); margin-bottom:8px">From: ${item.sender}</div>
                        <div>${keywordsHtml}</div>
                    </div>
                `;
            });
            html += `</div>`;
            // Solved Table
            if(solvedItems.length > 0) {
                html += `
                    <h3 style="color:var(--status-done); margin-top: 3rem; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 1rem;">Solved Items</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead><tr><th>Subject</th><th>Sender</th><th>Date</th><th></th></tr></thead>
                            <tbody>
                                ${solvedItems.map(item => `
                                    <tr onclick="router.navigate('mailbox', '${item.id}')" style="cursor:pointer">
                                        <td>${item.subject}</td>
                                        <td>${item.sender}</td>
                                        <td>${new Date(item.createdAt).toLocaleDateString()}</td>
                                        <td><span class="chip" style="background:var(--status-done); color:white; font-size:0.7em">SOLVED</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

        } else if (type === 'projects') {
             // Standard Project Grid WITH FAVORITES
             html += '<div class="card-grid">';
             
             // 1. Render Favorites
             if (favorites.length > 0) {
                 html += `<div class="favorites-header"><span>‚≠ê</span> Favorites</div>`;
                 favorites.forEach(item => html += this.buildCardHtml(type, item, item.status || 'ANA'));
             }

            // 2. Render Status Groups (for non-favorites)
            const statusOrder = ['ANA', 'DEV', 'APB', 'DONE'];
            statusOrder.forEach(status => {
                const groupItems = others.filter(i => (i.status || 'ANA') === status);
                if (groupItems.length > 0) {
                    html += `<div class="status-separator">
                                <span class="chip status-${status}" style="margin-right: 10px;">${status}</span>
                                <span>Projects</span>
                             </div>`;
                    groupItems.forEach(item => html += this.buildCardHtml(type, item, status));
                }
            });

            // Catch others
            const rest = others.filter(i => !statusOrder.includes(i.status || 'ANA'));
            if (rest.length > 0) {
                html += `<div class="status-separator">Uncategorized</div>`;
                rest.forEach(item => html += this.buildCardHtml(type, item, 'default'));
            }
            html += '</div>';

        } else {
            // Standard Grid for others (programs, tables, etc)
            html += '<div class="card-grid">';
            
            // 1. Favorites
            if (favorites.length > 0) {
                 html += `<div class="favorites-header"><span>‚≠ê</span> Favorites</div>`;
                 favorites.forEach(item => html += this.buildCardHtml(type, item));
                 html += `<div class="status-separator" style="margin-top:1rem; border-color: transparent; opacity:0.5; font-size:0.8rem;">All Items</div>`;
            }

            if (others.length === 0 && favorites.length === 0) {
                html += `<p style="grid-column: 1/-1; text-align: center; opacity: 0.5;">No items found.</p>`;
            }
            others.forEach(item => {
                html += this.buildCardHtml(type, item);
            });
            html += '</div>';
        }

        this.mainEl.innerHTML = html;
        const input = document.querySelector('.search-input');
        if (input && currentSearch) { input.setSelectionRange(currentSearch.length, currentSearch.length); input.focus(); }
    }

    buildCardHtml(type, item, status = null) {
        let extra = '';
        let cardClasses = 'card';
        
        // Favorite Logic
        const isFav = item.favorite === true;
        if (isFav) cardClasses += ' is-favorite';

        // Star Button HTML
        const starBtn = `
            <button class="favorite-btn ${isFav ? 'active' : ''}" 
                onclick="event.stopPropagation(); toggleFavorite('${type}', '${item.id}')">
                ${isFav ? '‚òÖ' : '‚òÜ'}
            </button>
        `;

        // 1. PROJECT STYLES
        if (type === 'projects') {
            cardClasses += ' project-card';
            cardClasses += ` status-border-${status || item.status || 'default'}`;
            
            const formattedTime = formatDuration(item.timeSpent);
            extra = `
                <div style="margin-top: 15px;">
                     ${renderStatusSlider(item.id, item.status, true)}
                </div>
                <div style="margin-top: 8px; text-align: right;">
                    <span style="font-size: 0.75rem; color: var(--md-sys-color-primary); font-weight: bold;">${formattedTime} logged</span>
                </div>
            `;
        }

        // 2. NEW: PROGRAM STYLES
        if (type === 'programs') {
            const pType = getProgramType(item.shortName || item.name);
            
            // Apply border class ONLY if not a favorite (Favorite gold border takes priority)
            if (!isFav) {
                cardClasses += ` prog-type-${pType}`;
            }

            // Define colors for the internal badge
            const colorMap = {
                'BATCH': '#673ab7',
                'INTERACTIVE': '#06b6d4',
                'SERVICE': '#f97316',
                'OTHER': '#94a3b8'
            };

            extra += `
                <div style="margin-top: 10px;">
                    <span class="prog-type-tag" style="background-color: ${colorMap[pType]}">${pType}</span>
                </div>
            `;
        }
        
        // Query styling
        if (type === 'queries') {
            if (item.updateIndicator === 'U') cardClasses += ' query-update';
            if (item.updateIndicator === 'D') cardClasses += ' query-delete';
        }

        return `
            <div class="${cardClasses}" onclick="router.navigate('${type}', '${item.id}')">
                ${starBtn}
                <h3 style="margin:0; padding-right: 20px;">${item.name || item.shortName}</h3>
                <p style="margin-top:4px">${item.description || item.shortDescription || 'No description'}</p>
                ${extra}
            </div>
        `;
    }

    renderDetail(type, id) {
        const item = store.get(type, id);
        if (!item) return this.renderList(type);

        let content = '';

        // --- UPDATED HEADER SECTION ---
        content += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <button class="btn btn-outlined btn-small" onclick="router.navigate('${type}')">‚Üê Back to List</button>
                
                <div style="display: flex; gap: 8px;">
                    <button id="btn-conf-copy" class="btn btn-tonal btn-small" onclick="ui.copyConfluenceObject('${type}', '${id}')" title="Copy as Wiki Markup">
                        <span style="font-size: 1.1em; margin-right: 4px;">üìò</span> Copy to Confluence
                    </button>
                    
                    ${!item.isSystem ? `<button class="btn btn-danger btn-small" onclick="deleteObject('${type}', '${id}')">Delete</button>` : ''}
                </div>
            </div>
            <div class="detail-container">
        `;
        // --- END HEADER SECTION ---

        // Render specific editor based on type
        if (type === 'programs') content += renderProgramDetail(item);
        if (type === 'tables') content += renderTableDetail(item);
        if (type === 'queries') content += renderQueryDetail(item);
        if (type === 'projects') content += renderProjectDetail(item);
        if (type === 'mailbox') content += renderMailboxDetail(item);

        content += `</div>`;
        this.mainEl.innerHTML = content;
    }
}

/**
 * --- DASHBOARD RENDERER ---
 */
function renderDashboard() {
    const isWeekView = !router.dashboardDate;
    
    let html = `
        <div class="header-row">
            <h1 class="page-title">Dashboard</h1>
            <button class="btn btn-tonal" onclick="ui.openReminderModal()">+ Add Reminder</button>
        </div>
        
        <!-- Quick Links -->
        ${renderQuickLinksSection()}
        
        <!-- Global To-Do's -->
        ${renderGlobalTodosSection()}

        <div class="dashboard-controls">
            <div style="flex: 1;">
                <label>Select Date for Daily View</label>
                <input type="date" value="${router.dashboardDate || ''}" 
                    onchange="router.dashboardDate = this.value; router.renderList('dashboard')">
            </div>
            <div style="flex: 1; display:flex; align-items:flex-end; justify-content: flex-end;">
                ${!isWeekView ? '<button class="btn btn-outlined" onclick="router.dashboardDate = null; router.renderList(\'dashboard\')">Clear & Show Workweek</button>' : '<span style="color:var(--md-sys-color-secondary); padding: 8px;">Viewing Current Workweek</span>'}
            </div>
        </div>
    `;

    if (isWeekView) {
        html += renderWeeklyChart();
    } else {
        html += renderDailyTimeline(router.dashboardDate);
    }

    document.getElementById('mainContent').innerHTML = html;
}

/* Quick Links Logic */
function renderQuickLinksSection() {
    const links = store.getAll('quickLinks');
    
    let itemsHtml = links.map((link, index) => `
        <div class="quick-link-card" draggable="true" 
             onclick="window.open('${link.url}', '_blank')"
             ondragstart="handleDragStart(event, ${index})" 
             ondrop="handleDrop(event, ${index})" 
             ondragover="handleDragOver(event)">
            <div class="quick-link-delete" onclick="event.stopPropagation(); ui.openDeleteConfirm('${link.id}')">‚úï</div>
            <div class="quick-link-icon">${link.icon || 'üîó'}</div>
            <div class="quick-link-title">${link.title}</div>
            <div class="quick-link-desc">${link.description}</div>
        </div>
    `).join('');

    return `
        <h3 style="color:var(--md-sys-color-primary)">Quick Links</h3>
        <div class="quick-link-grid">
            ${itemsHtml}
            <div class="quick-link-add" onclick="ui.openCreateModal('quickLinks')">
                <div style="text-align:center;">
                    <div style="font-size:1.5rem; margin-bottom:0.5rem;">+</div>
                    <div>Add Link</div>
                </div>
            </div>
        </div>
    `;
}

let draggedIdx = null;

function handleDragStart(ev, index) {
    draggedIdx = index;
    ev.dataTransfer.effectAllowed = "move";
}

function handleDragOver(ev) {
    ev.preventDefault();
}

function handleDrop(ev, targetIdx) {
    ev.preventDefault();
    if (draggedIdx === null || draggedIdx === targetIdx) return;
    
    // Reorder array
    const links = store.getAll('quickLinks');
    const movedItem = links.splice(draggedIdx, 1)[0];
    links.splice(targetIdx, 0, movedItem);
    
    store.data.quickLinks = links;
    store.save();
    router.renderList('dashboard');
    draggedIdx = null;
}

/* Global To-Do Logic */
function renderGlobalTodosSection() {
    // 1. Gather Project Todos
    const projectTodos = store.getAll('projects')
        .filter(p => p.id !== 'mailbox_fixed')
        .flatMap(p => (p.todos || [])
            .map((t, idx) => ({ 
                ...t, 
                type: 'project', 
                parentName: p.name, 
                parentId: p.id, 
                originalIdx: idx 
            }))
        )
        .filter(t => !t.done);

    // 2. Gather Global Todos
    const globalTodos = store.getAll('globalTodos')
        .map(t => ({ ...t, type: 'global', parentName: 'Global', parentId: 'global' }))
        .filter(t => !t.done);

    // 3. Merge & Sort by Creation
    const allTodos = [...projectTodos, ...globalTodos].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

    return `
        <h3 style="color:var(--md-sys-color-primary)">To-Do List</h3>
        <div class="global-todo-container">
            <div class="input-group" style="margin-bottom:1rem; flex-direction:row; gap:12px;">
                <input type="text" id="newGlobalTodo" placeholder="Add a global task..." onkeydown="if(event.key==='Enter') addGlobalTodo()">
                <button class="btn btn-primary" onclick="addGlobalTodo()">Add</button>
            </div>
            
            <div id="dashboard-todos-list">
                ${allTodos.length === 0 ? '<p style="text-align:center; opacity:0.6; padding:1rem;">All caught up! No active tasks.</p>' : ''}
                ${allTodos.map(t => `
                    <div class="todo-item-row">
                        <input type="checkbox" style="width:20px; height:20px; cursor:pointer;" 
                            onchange="toggleGlobalTodoItem('${t.type}', '${t.parentId}', '${t.id || t.originalIdx}')">
                        <div style="flex:1;">
                            <span style="font-weight:500; font-size:1.05rem;">${t.text}</span>
                        </div>
                        <div class="todo-tag ${t.type === 'global' ? 'tag-global' : 'tag-project'}" 
                             ${t.type === 'project' ? `onclick="router.navigate('projects', '${t.parentId}')"` : ''}>
                             ${t.type === 'global' ? '‚òÖ ' : ''}${t.parentName}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function addGlobalTodo() {
    const input = document.getElementById('newGlobalTodo');
    const val = input.value.trim();
    if (!val) return;
    
    store.add('globalTodos', {
        text: val,
        done: false
    });
    
    router.renderList('dashboard');
}

function toggleGlobalTodoItem(type, parentId, idOrIdx) {
    if (type === 'global') {
        const todo = store.get('globalTodos', idOrIdx);
        if (todo) {
            todo.done = true;
            store.update('globalTodos', idOrIdx, { done: true });
        }
    } else {
        // Project todo
        const project = store.get('projects', parentId);
        if (project && project.todos && project.todos[idOrIdx]) {
            project.todos[idOrIdx].done = true;
            store.update('projects', parentId, { todos: project.todos });
        }
    }
    // Refresh
    setTimeout(() => router.renderList('dashboard'), 200);
}

// --- 1. State Management (Place this outside the render function) ---
let currentWeekOffset = 0;
let logWorkViewMode = 'all'; // 'all' or 'week'

window.changeWeek = function(direction) {
    if (direction == 0) {
		currentWeekOffset = 0;
	}
	else {
		currentWeekOffset += direction;
		// Fix: Re-render the dashboard view using the router to update the chart correctly
	}
	router.renderList('dashboard')
};

// --- 2. The Fancy Render Function ---
function renderWeeklyChart() {
    // --- CSS Styles (Scoped to this component for portability) ---
    // Find this inside function renderWeeklyChart()
// Inside function renderWeeklyChart()...

const styles = `
    <style>
        .fancy-wrapper { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: var(--md-sys-color-on-surface); }
        .fancy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* Chart Area */
        .chart-container { position: relative; height: 250px; display: flex; align-items: flex-end; padding-left: 50px; margin-bottom: 30px; overflow: visible; }
        .chart-grid { position: absolute; inset: 0 0 0 50px; display: flex; flex-direction: column-reverse; justify-content: space-between; pointer-events: none; z-index: 0; }
        .grid-line { width: 100%; border-top: 1px dashed var(--md-sys-color-outline-variant); height: 0; opacity: 0.5; }
        .y-axis { position: absolute; left: 0; top: 0; bottom: 0; width: 40px; display: flex; flex-direction: column-reverse; justify-content: space-between; font-size: 0.75rem; color: var(--md-sys-color-secondary); text-align: right; padding-right: 10px; }
        
        .bars-area { display: flex; width: 100%; height: 100%; z-index: 1; justify-content: space-around; align-items: flex-end; }
        .day-col { display: flex; flex-direction: column; align-items: center; width: 14%; height: 100%; justify-content: flex-end; position: relative; }
        .bar-stack { width: 60%; display: flex; flex-direction: column-reverse; border-radius: 4px; overflow: visible; transition: height 0.3s ease; position: relative; }
        .day-label { margin-top: 8px; font-size: 0.85rem; font-weight: 600; color: var(--md-sys-color-secondary); }
        .date-sublabel { font-size: 0.7rem; color: var(--md-sys-color-secondary); margin-top: 2px; opacity: 0.8; }

        /* Tooltip Fixes */
        .bar-segment { width: 100%; position: relative; transition: opacity 0.2s; cursor: pointer; }
        .bar-segment:first-child { border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }
        .bar-segment:last-child { border-top-left-radius: 4px; border-top-right-radius: 4px; }
        
        .bar-segment::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            display: none;
            z-index: 100;
            pointer-events: none;
        }
        .bar-segment:hover::after { display: block; }
        
        .project-breakdown { margin-top: 20px; border-top: 1px solid var(--md-sys-color-outline-variant); padding-top: 20px; }
        
        /* --- ALIGNMENT FIXES HERE --- */
        .pb-row { display: flex; align-items: center; margin-bottom: 12px; font-size: 0.9rem; color: var(--md-sys-color-on-surface); }
        
        .pb-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0; /* Prevents dot from squishing */
        }

        .pb-name {
            width: 160px; /* FIXED WIDTH: Ensures all bars start at same point */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Adds ... if name is too long */
            margin-right: 15px;
        }

        .pb-track { 
            flex-grow: 1; /* Takes up remaining space */
            height: 8px; 
            background: var(--md-sys-color-surface-variant); 
            border-radius: 4px; 
            overflow: hidden; 
            margin-right: 15px; 
        }
        
        .pb-fill { height: 100%; width: var(--target-width); border-radius: 4px; transition: width 1s ease-out; }
        
        .pb-time { width: 60px; text-align: right; font-variant-numeric: tabular-nums; color: var(--md-sys-color-secondary); font-size: 0.85rem; flex-shrink: 0; }
    </style>
`;

    // --- 3. Logic & Calculation ---

    // A. Date Math with Offset
    const today = new Date();
    today.setDate(today.getDate() + (currentWeekOffset * 7)); // Apply global offset
    
    const dayOfWeek = today.getDay(); 
    const diffToMon = (dayOfWeek === 0 ? -6 : 1) - dayOfWeek;
    
    const monday = new Date(today);
    monday.setDate(today.getDate() + diffToMon);
    monday.setHours(0,0,0,0);

    const weekData = {};
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
    
    // Initialize Week & tracking for Project Summary
    const projectSummary = {}; 
    let grandTotal = 0;

    days.forEach((d, index) => {
        const date = new Date(monday.getTime() + 86400000 * index);
        weekData[d] = { date: date, total: 0, projects: {} };
    });

    // B. Aggregate Data
    const sessions = store.data.workSessions || [];
    
    sessions.forEach(s => {
        const sDate = new Date(s.start);
        const dayKey = Object.keys(weekData).find(key => {
            const wDate = weekData[key].date;
            return wDate.getDate() === sDate.getDate() && 
                   wDate.getMonth() === sDate.getMonth() && 
                   wDate.getFullYear() === sDate.getFullYear();
        });

        if (dayKey) {
            // Daily aggregation
            weekData[dayKey].total += s.duration;
            if (!weekData[dayKey].projects[s.projectId]) {
                weekData[dayKey].projects[s.projectId] = 0;
            }
            weekData[dayKey].projects[s.projectId] += s.duration;

            // Global (Weekly) aggregation
            grandTotal += s.duration;
            if (!projectSummary[s.projectId]) projectSummary[s.projectId] = 0;
            projectSummary[s.projectId] += s.duration;
        }
    });

    // C. Scaling Logic
    let maxDuration = Math.max(1000 * 60 * 60, ...Object.values(weekData).map(d => d.total));
    maxDuration = maxDuration * 1.1; // 10% headroom

    const yLabels = [];
    for(let i=0; i<=5; i++) yLabels.push(formatDurationShort((maxDuration / 5) * i));

    // D. Build Project Breakdown List (Sorted by duration)
    const sortedProjectIds = Object.keys(projectSummary).sort((a,b) => projectSummary[b] - projectSummary[a]);
    
    const projectListHtml = sortedProjectIds.map(pid => {
        const duration = projectSummary[pid];
        const percent = grandTotal > 0 ? (duration / grandTotal) * 100 : 0;
        const project = store.get('projects', pid) || { name: 'Unknown Project' };
        const color = stringToColor(pid);

        return `
            <div class="pb-row" onclick="router.navigate('projects', '${pid}')" style="cursor: pointer;">
                <div class="pb-color" style="background-color: ${color}"></div>
                <div class="pb-name" title="${project.name}">${project.name}</div>
                <div class="pb-track">
                    <div class="pb-fill" style="background-color: ${color}; --target-width: ${percent}%;"></div>
                </div>
                <div class="pb-time">${formatDurationShort(duration)}</div>
            </div>
        `;
    }).join('');

    // --- 4. Render HTML ---
    
    // Formatting the date range for the header
    const friday = new Date(monday);
    friday.setDate(monday.getDate() + 4);
    const dateRangeStr = `${monday.toLocaleDateString(undefined, {month:'short', day:'numeric'})} - ${friday.toLocaleDateString(undefined, {month:'short', day:'numeric'})}`;

    return `
        ${styles}
        <div class="fancy-wrapper">
            
            <div class="fancy-header">
                <div>
                    <h3 style="margin:0;">Weekly Activity</h3>
                    <div style="font-size: 0.9rem; color: #888; margin-top: 4px;">${dateRangeStr}</div>
                </div>
                <div style="display:flex; gap: 8px;">
					<button class="btn btn-outlined btn-small" onclick="window.changeWeek(-1)">‚Üê Prev</button>
					<button class="btn btn-tonal btn-small" onclick="window.changeWeek(0)">Today</button>
					<button class="btn btn-outlined btn-small" onclick="window.changeWeek(1)">Next ‚Üí</button>
				</div>
            </div>
            
            <div class="chart-container">
                <div class="grid-lines chart-grid">
                    ${[0,1,2,3,4,5].map(() => '<div class="grid-line"></div>').join('')}
                </div>
                <div class="y-axis">
                    ${yLabels.map(l => `<span>${l}</span>`).join('')}
                </div>
                
                <div class="bars-area">
                    ${Object.keys(weekData).map(day => {
                        const dayObj = weekData[day];
                        const totalHeight = (dayObj.total / maxDuration) * 100;
                        
                        // Stack Segments
                        const stackHtml = Object.keys(dayObj.projects).map(pid => {
                            const pDuration = dayObj.projects[pid];
                            const pHeight = (pDuration / dayObj.total) * 100;
                            const project = store.get('projects', pid) || { name: 'Unknown' };
                            const color = stringToColor(pid);
                            
                            return `
                                <div class="bar-segment" 
                                     style="height: ${pHeight}%; background-color: ${color};"
                                     data-tooltip="${project.name}: ${formatDurationShort(pDuration)}"
                                     onclick="event.stopPropagation(); router.navigate('projects', '${pid}')">
                                </div>
                            `;
                        }).join('');

                        return `
                            <div class="day-col">
                                <div class="bar-stack" style="height: ${totalHeight}%;">
                                    ${stackHtml}
                                </div>
                                <div class="day-label">${day}</div>
                                <div class="date-sublabel">${dayObj.date.getDate()}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>

            <div class="project-breakdown">
                <h4 style="margin: 0 0 15px 0; font-size: 0.9rem; text-transform: uppercase; color: #888; letter-spacing: 0.5px;">
                    Project Breakdown (Total: ${formatDurationShort(grandTotal)})
                </h4>
                ${projectListHtml || '<div style="color:#999; text-align:center; padding: 20px;">No logs this week</div>'}
            </div>
        </div>
    `;
}

function renderDailyTimeline(dateStr) {
    if(!dateStr) return '';
    
    // Parse target date (local time)
    const targetDate = new Date(dateStr);
    const timelineItems = [];

    // 1. Work Logs (Projects + Mailbox)
    ['projects', 'mailbox'].forEach(type => {
        store.getAll(type).forEach(item => {
            (item.workLog || []).forEach(log => {
                if (isSameDay(new Date(log.timestamp), targetDate)) {
                    timelineItems.push({
                        time: new Date(log.timestamp),
                        type: 'log',
                        title: `Log: ${item.name || item.subject}`,
                        desc: log.content,
                        objType: type,
                        objId: item.id
                    });
                }
            });
        });
    });

    // 2. Created Items
    ['programs', 'tables', 'queries', 'projects', 'mailbox'].forEach(type => {
        store.getAll(type).forEach(item => {
            if (item.createdAt && isSameDay(new Date(item.createdAt), targetDate)) {
                timelineItems.push({
                    time: new Date(item.createdAt),
                    type: 'create',
                    title: `Created ${type.slice(0, -1)}: ${item.name || item.shortName || item.subject}`,
                    desc: item.description || item.shortDescription || 'No description',
                    objType: type,
                    objId: item.id
                });
            }
        });
    });

    // 3. Work Sessions
    (store.data.workSessions || []).forEach(sess => {
        if (isSameDay(new Date(sess.start), targetDate)) {
            const project = store.get('projects', sess.projectId) || { name: 'Unknown Project' };
            timelineItems.push({
                time: new Date(sess.start),
                type: 'session',
                title: `Logged work on ${project.name}`,
                desc: `Duration: ${formatDuration(sess.duration)}`,
                objType: 'projects',
                objId: sess.projectId
            });
        }
    });

    // Sort by time
    timelineItems.sort((a, b) => a.time - b.time);

    return `
        <div class="chart-wrapper">
            <h3>Timeline: ${new Date(dateStr).toLocaleDateString()}</h3>
            <div class="timeline-container">
                ${timelineItems.length === 0 ? '<p style="opacity:0.6">No activity found on this day.</p>' : ''}
                ${timelineItems.map(item => `
                    <div class="timeline-item type-${item.type}" onclick="router.navigate('${item.objType}', '${item.objId}')" style="cursor:pointer">
                        <div class="timeline-time">${item.time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                        <div class="timeline-content">
                            <h4>${item.title}</h4>
                            <p>${formatWorkLogContent(item.desc)}</p>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Helpers for Chart
function isSameDay(d1, d2) {
    return d1.getDate() === d2.getDate() &&
           d1.getMonth() === d2.getMonth() &&
           d1.getFullYear() === d2.getFullYear();
}

function formatDurationShort(ms) {
    const hours = Math.floor(ms / (1000 * 60 * 60));
    const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
}

function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return '#' + '00000'.substring(0, 6 - c.length) + c;
}

/**
 * --- RENDERERS ---
 */
/**
 * --- ORPHAN LOGIC & RENDERER ---
 */

function scanTextForRefs(text, callback) {
    if(!text) return;
    // Regex matches /table{Name} and /program{Name}
    const tableRegex = /\/table\{([^}]+)\}/g;
    const progRegex = /\/program\{([^}]+)\}/g;
    
    let match;
    while ((match = tableRegex.exec(text)) !== null) callback('tables', match[1]);
    while ((match = progRegex.exec(text)) !== null) callback('programs', match[1]);
}

function getOrphanData() {
    const missing = { programs: new Set(), tables: new Set() };
    
    // Helper: checks if exists, if not adds to missing set
    const checkAndAdd = (type, name) => {
        if(!name) return;
        const exists = store.findByName(type, name);
        if(!exists) missing[type].add(name);
    };

    // 1. Scan Projects (Links + Logs + Description)
    store.getAll('projects').forEach(p => {
        (p.linkedTables || []).forEach(t => checkAndAdd('tables', t));
        (p.linkedPrograms || []).forEach(prog => checkAndAdd('programs', prog));
        scanTextForRefs(p.description, checkAndAdd);
        scanTextForRefs(p.notes, checkAndAdd);
        (p.workLog || []).forEach(log => scanTextForRefs(log.content, checkAndAdd));
        (p.todos || []).forEach(todo => scanTextForRefs(todo.text, checkAndAdd));
    });
    
    // 2. Scan Programs (Links + Flow)
    store.getAll('programs').forEach(p => {
        (p.linkedTables || []).forEach(t => checkAndAdd('tables', t));
        (p.linkedPrograms || []).forEach(prog => checkAndAdd('programs', prog));
        scanTextForRefs(p.flow, checkAndAdd);
        scanTextForRefs(p.shortDescription, checkAndAdd);
    });

    // 3. Scan Tables (Relationships)
    store.getAll('tables').forEach(t => {
        (t.links || []).forEach(l => checkAndAdd('tables', l.toTable));
    });

    // 4. Scan Mailbox (Logs)
    store.getAll('mailbox').forEach(m => {
        (m.workLog || []).forEach(log => scanTextForRefs(log.content, checkAndAdd));
    });

    return {
        programs: Array.from(missing.programs).sort(),
        tables: Array.from(missing.tables).sort()
    };
}

function renderOrphanList() {
    const data = getOrphanData();
    const hasOrphans = data.programs.length > 0 || data.tables.length > 0;

    let html = `
        <div class="header-row">
            <h1 class="page-title">Orphan Objects</h1>
            <button class="btn btn-outlined" onclick="router.renderList('orphans')">‚Üª Refresh Scan</button>
        </div>
        <p style="margin-bottom: 2rem; color: var(--md-sys-color-secondary);">
            The following objects are referenced in your documentation (via links, relationships, or text tags like <code>/table{Name}</code>), 
            but do not exist in the database. Click a card to create it.
        </p>
    `;

    if (!hasOrphans) {
        html += `
            <div style="text-align:center; padding: 4rem; opacity: 0.6;">
                <div style="font-size: 3rem;">‚ú®</div>
                <h3>Clean System!</h3>
                <p>No orphan references found.</p>
            </div>
        `;
    } else {
        // Render Missing Tables
        if (data.tables.length > 0) {
            html += `<h3 style="color:var(--md-sys-color-primary); border-bottom: 1px solid var(--md-sys-color-outline-variant); padding-bottom: 8px;">Missing Tables (${data.tables.length})</h3>`;
            html += `<div class="card-grid" style="margin-bottom: 2rem;">`;
            html += data.tables.map(name => `
                <div class="card" style="border-left: 5px solid #eab308; cursor: pointer;" 
                     onclick="ui.openCreateModal('tables', '${name}')" title="Click to Create Table">
                    <h3 style="margin:0">üõ¢Ô∏è ${name}</h3>
                    <p style="margin-top:4px; font-size:0.85rem;">Referenced as Table</p>
                    <div style="margin-top:10px; font-size:0.8rem; color:var(--md-sys-color-primary); font-weight:bold;">+ Create Now</div>
                </div>
            `).join('');
            html += `</div>`;
        }

        // Render Missing Programs
        if (data.programs.length > 0) {
            html += `<h3 style="color:var(--md-sys-color-primary); border-bottom: 1px solid var(--md-sys-color-outline-variant); padding-bottom: 8px;">Missing Programs (${data.programs.length})</h3>`;
            html += `<div class="card-grid">`;
            html += data.programs.map(name => `
                <div class="card" style="border-left: 5px solid #3b82f6; cursor: pointer;" 
                     onclick="ui.openCreateModal('programs', '${name}')" title="Click to Create Program">
                    <h3 style="margin:0">üì¶ ${name}</h3>
                    <p style="margin-top:4px; font-size:0.85rem;">Referenced as Program</p>
                    <div style="margin-top:10px; font-size:0.8rem; color:var(--md-sys-color-primary); font-weight:bold;">+ Create Now</div>
                </div>
            `).join('');
            html += `</div>`;
        }
    }

    document.getElementById('mainContent').innerHTML = html;
}
// 1. PROGRAMS
function renderProgramDetail(item) {
    return `
        <h1 style="margin-right: 80px;">${item.longName} (${item.shortName})</h1>
        <p>${item.shortDescription}</p>
        
        <div class="section-header">Program Flow</div>
        <textarea onchange="updateField('programs', '${item.id}', 'flow', this.value)">${item.flow || ''}</textarea>

        <div class="section-header">
            Related Tables
            <button class="btn btn-tonal btn-small" onclick="addListItem('programs', '${item.id}', 'linkedTables')">+ Add Table Link</button>
        </div>
    
        <div class="card-grid" id="prog-tables-list" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
            ${(item.linkedTables || []).map((t, idx) => renderReferenceCard('programs', item.id, 'linkedTables', idx, t, 'tables')).join('')}
        </div>

        <div class="section-header">
            Related Programs
            <button class="btn btn-tonal btn-small" onclick="addListItem('programs', '${item.id}', 'linkedPrograms')">+ Add Program Link</button>
        </div>
        <div class="card-grid" id="prog-progs-list" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
             ${(item.linkedPrograms || []).map((p, idx) => renderReferenceCard('programs', item.id, 'linkedPrograms', idx, p, 'programs')).join('')}
        </div>
    `;
}

function renderReferenceCard(type, parentId, fieldName, index, value, targetType) {
    const targetObj = store.findByName(targetType, value);
    
    let infoHtml = `
        <div class="ref-desc" style="font-style: italic; opacity: 0.6;">Object not found in system</div>
    `;
    
    if (targetObj) {
        const desc = targetObj.description || targetObj.shortDescription || 'No description available';
        infoHtml = `
            <div class="ref-desc" title="${desc}">${desc}</div>
            <div style="margin-top: 4px;">
                <button class="btn btn-tonal btn-small" style="height: 24px; padding: 0 8px; font-size: 0.7rem;" onclick="router.navigate('${targetType}', '${targetObj.id}')">‚ûú View ${targetType.slice(0, -1)}</button>
            </div>
        `;
    }

    return `
        <div class="ref-card">
            <div class="ref-header">
                <input class="table-inline-input" type="text" 
                    style="font-weight: bold; color: var(--md-sys-color-primary); border-bottom: 1px dashed var(--md-sys-color-outline-variant) !important;" 
                    value="${value}" 
                    placeholder="Enter name..."
                    onchange="updateSubItemValue('${type}', '${parentId}', '${fieldName}', ${index}, this.value)">
                <button class="btn btn-danger btn-small" style="height: 24px; width: 24px; padding: 0;" onclick="removeSubItem('${type}', '${parentId}', '${fieldName}', ${index})">‚úï</button>
            </div>
            ${infoHtml}
        </div>
    `;
}

// 2. TABLES
let tableFilterQuery = '';

function renderTableDetail(item) {
    const fields = item.fields || [];
    const filteredFields = fields.filter(f => 
        f.name.toLowerCase().includes(tableFilterQuery.toLowerCase()) || 
        f.desc.toLowerCase().includes(tableFilterQuery.toLowerCase())
    );

    // --- MIGRATION: Single Link -> Multiple Links ---
    if (item.linkedTable && (!item.links || item.links.length === 0)) {
        if (!item.links) item.links = [];
        item.links.push({
            id: Date.now().toString(),
            toTable: item.linkedTable,
            join: item.linkDesc || '',
            bidirectional: false
        });
        item.linkedTable = null; // Clear old
        item.linkDesc = null;
        store.save(); // Persist migration
    }

    const outgoingLinks = item.links || [];

    // --- DYNAMIC SEARCH: Incoming Bi-Directional Links ---
    // Now including index to allow removal
    const incomingLinks = store.getAll('tables').flatMap(t => {
        if (!t.links) return [];
        return t.links
            .map((link, idx) => ({ ...link, originalIdx: idx, originalId: t.id, fromTable: t.name })) // Map first to keep index
            .filter(l => l.toTable.toLowerCase() === item.name.toLowerCase() && l.bidirectional)
            .map(l => ({
                fromTable: l.fromTable,
                join: l.join,
                isIncoming: true,
                originalId: l.originalId,
                originalIdx: l.originalIdx,
                bidirectional: true
            }));
    });

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-right: 80px;">
            <h1>Table: ${item.name}</h1>
            <div style="text-align:right">
                <span class="chip" style="background:#6750a4">${fields.length} Fields</span>
            </div>
        </div>
        
        <div class="input-group">
            <label>Description</label>
            <input type="text" value="${item.description}" placeholder="General table description..." onchange="updateField('tables', '${item.id}', 'description', this.value)">
        </div>

        <div class="section-header">
            Fields Management
            <button class="btn btn-primary btn-small" onclick="addSubItem('tables', '${item.id}', 'fields', {name:'', desc:'', ex:'', comm:''})">+ New Field</button>
        </div>

        <div class="filter-bar">
            <input type="text" class="search-input" placeholder="Search fields by name or description..." value="${tableFilterQuery}" 
                oninput="tableFilterQuery = this.value; refreshTableFields('${item.id}')">
        </div>

        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 25%">Name</th>
                        <th style="width: 35%">Description</th>
                        <th style="width: 15%">Example</th>
                        <th style="width: 15%">Comment</th>
                        <th style="width: 10%">Actions</th>
                    </tr>
                </thead>
                <tbody id="table-fields-body">
                    ${renderFieldRows(item.id, filteredFields, fields)}
                </tbody>
            </table>
        </div>

        <div class="section-header">
            Table Relationships (Advanced)
            <button class="btn btn-tonal btn-small" onclick="ui.openLinkModal('${item.id}', '${item.name}')">+ Add Link</button>
        </div>
        
        <div class="card-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
            ${outgoingLinks.map((link, idx) => `
                <div class="ref-card" style="border-left: 4px solid var(--md-sys-color-primary);">
                    <div class="ref-header">
                        <span class="ref-title" onclick="const t = store.findByName('tables', '${link.toTable}'); if(t) router.navigate('tables', t.id);">‚ûú ${link.toTable}</span>
                        <button class="btn btn-danger btn-small" style="height:24px;width:24px;padding:0" onclick="removeLink('${item.id}', ${idx})">‚úï</button>
                    </div>
                    <div class="ref-desc" style="white-space:normal; font-family:monospace; color: var(--md-sys-color-secondary); background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px; margin-top:5px;">
                        ${link.join || 'No join statement'}
                    </div>
                    ${link.bidirectional ? '<span class="chip" style="background:var(--md-sys-color-secondary); font-size: 0.65rem; align-self:start; margin-top:5px;">Bi-directional</span>' : ''}
                </div>
            `).join('')}

            ${incomingLinks.map(link => `
                 <div class="ref-card" style="border-left: 4px solid var(--md-sys-color-primary);">
                    <div class="ref-header">
                        <span class="ref-title" onclick="router.navigate('tables', '${link.originalId}')">‚¨ÖÔ∏è From: ${link.fromTable}</span>
                        <button class="btn btn-danger btn-small" style="height:24px;width:24px;padding:0" title="Remove Link from Source" onclick="removeIncomingLink('${link.originalId}', ${link.originalIdx}, '${item.id}')">‚úï</button>
                    </div>
                    <div class="ref-desc" style="white-space:normal; font-family:monospace; color: var(--md-sys-color-secondary); background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px; margin-top:5px;">
                        ${link.join || 'No join statement'}
                    </div>
                    <span class="chip" style="background:var(--md-sys-color-secondary); font-size: 0.65rem; align-self:start; margin-top:5px;">Bi-directional (Incoming)</span>
                </div>
            `).join('')}
            
            ${outgoingLinks.length === 0 && incomingLinks.length === 0 ? '<p style="opacity:0.6; font-style:italic;">No links defined.</p>' : ''}
        </div>
    `;
}

function renderFieldRows(id, filtered, allFields) {
    if (filtered.length === 0) return '<tr><td colspan="5" style="text-align:center; padding: 20px; opacity: 0.5;">No fields match your search.</td></tr>';
    
    return filtered.map(f => {
        const originalIdx = allFields.indexOf(f);
        return `
            <tr>
                <td><input class="table-inline-input" type="text" value="${f.name}" placeholder="field_name" onchange="updateSubField('tables', '${id}', 'fields', ${originalIdx}, 'name', this.value)"></td>
                <td><input class="table-inline-input" type="text" value="${f.desc}" placeholder="Describe..." onchange="updateSubField('tables', '${id}', 'fields', ${originalIdx}, 'desc', this.value)"></td>
                <td><input class="table-inline-input" type="text" value="${f.ex}" placeholder="e.g. 123" onchange="updateSubField('tables', '${id}', 'fields', ${originalIdx}, 'ex', this.value)"></td>
                <td><input class="table-inline-input" type="text" value="${f.comm}" placeholder="..." onchange="updateSubField('tables', '${id}', 'fields', ${originalIdx}, 'comm', this.value)"></td>
                <td style="display:flex; gap:4px;">
                    <button class="btn btn-tonal btn-small" style="padding: 0; width: 28px; height: 28px;" title="Expand Details" onclick="ui.openFieldModal('${id}', ${originalIdx})">‚§¢</button>
                    <button class="btn btn-danger btn-small" style="padding: 0; width: 28px; height: 28px;" onclick="removeSubItem('tables', '${id}', 'fields', ${originalIdx})">‚úï</button>
                </td>
            </tr>
        `;
    }).join('');
}

function refreshTableFields(id) {
    const item = store.get('tables', id);
    const body = document.getElementById('table-fields-body');
    const fields = item.fields || [];
    const filteredFields = fields.filter(f => 
        f.name.toLowerCase().includes(tableFilterQuery.toLowerCase()) || 
        f.desc.toLowerCase().includes(tableFilterQuery.toLowerCase())
    );
    body.innerHTML = renderFieldRows(id, filteredFields, fields);
}

function removeLink(tableId, index) {
    const item = store.get('tables', tableId);
    item.links.splice(index, 1);
    store.update('tables', tableId, { links: item.links });
    router.renderDetail('tables', tableId);
}

function removeIncomingLink(sourceTableId, linkIndex, currentViewId) {
    if(confirm('Removing this Incoming Link will remove the connection from the Source Table as well. Continue?')) {
        const sourceTable = store.get('tables', sourceTableId);
        if (sourceTable && sourceTable.links) {
            sourceTable.links.splice(linkIndex, 1);
            store.update('tables', sourceTableId, { links: sourceTable.links });
            // Refresh current view (target table)
            router.renderDetail('tables', currentViewId);
        }
    }
}

// 3. QUERIES
function renderQueryDetail(item) {
    const regex = /:([a-zA-Z0-9_]+)/g;
    const matches = [...(item.query || '').matchAll(regex)].map(m => m[1]);
    const uniqueParams = [...new Set(matches)];

    if (!item.paramDescs) item.paramDescs = {};

    return `
        <h1 style="margin-right: 80px;">Query: ${item.name}</h1>
        <div class="input-group">
            <label>Update Indicator</label>
            <select onchange="updateField('queries', '${item.id}', 'updateIndicator', this.value)">
                <option value="R" ${item.updateIndicator === 'R' ? 'selected':''}>Read</option>
                <option value="C" ${item.updateIndicator === 'C' ? 'selected':''}>Create</option>
                <option value="U" ${item.updateIndicator === 'U' ? 'selected':''}>Update</option>
                <option value="D" ${item.updateIndicator === 'D' ? 'selected':''}>Delete</option>
            </select>
        </div>
        
        <div class="section-header">SQL / Query</div>
        <textarea style="font-family: monospace; background: #222; color: #bada55;" 
            onchange="updateField('queries', '${item.id}', 'query', this.value); router.renderDetail('queries', '${item.id}')">${item.query || ''}</textarea>

        <div class="section-header">Detected Parameters</div>
        ${uniqueParams.length > 0 ? uniqueParams.map(p => `
            <div class="input-group">
                <label>:${p}</label>
                <input type="text" placeholder="Description for ${p}" value="${item.paramDescs[p] || ''}" 
                    onchange="let pd = store.get('queries', '${item.id}').paramDescs || {}; pd['${p}'] = this.value; updateField('queries', '${item.id}', 'paramDescs', pd)">
            </div>
        `).join('') : '<p>No parameters (use :paramName) detected.</p>'}
    `;
}

function renderProjectDetail(item) {
    const formattedTime = formatDuration(item.timeSpent);
    
    // --- 1. PREPARE LOGS (FILTER & SORT) ---
    let logs = item.workLog || [];
    
    // Add legacy note if exists
    if (logs.length === 0 && item.notes) {
        logs.push({ id: 'legacy', timestamp: item.createdAt || new Date().toISOString(), content: item.notes, isLegacy: true });
    }

    // Filter: Important Only
    if (projectLogFilter.importantOnly) {
        logs = logs.filter(l => l.isImportant);
    }

    // Sort: Date
    logs.sort((a, b) => {
        const dateA = new Date(a.timestamp);
        const dateB = new Date(b.timestamp);
        return projectLogFilter.sortAscending ? dateA - dateB : dateB - dateA;
    });

    return `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-right: 80px;">
            <div style="display:flex; align-items:center; gap: 10px;">
                <div style="width: 6px; height: 40px; border-radius:3px; background-color: var(--status-${(item.status || 'ANA').toLowerCase()});"></div>
                <h1>${item.name}</h1>
            </div>
            <div style="text-align:right">
                <div style="font-size:0.8rem; margin-top:5px; color:var(--md-sys-color-primary); display:flex; align-items:center; justify-content:flex-end; gap:8px;">
                    <span>${formattedTime} total</span>
                    <button class="btn btn-outlined btn-small" onclick="adjustTime('${item.id}')" title="Manually Adjust Time">Adjust</button>
                </div>
            </div>
        </div>
        
        <div class="input-group" style="margin-top: 1rem;">
            <label>Description</label>
            <textarea placeholder="Project description..." style="min-height: 60px;" 
                onchange="updateField('projects', '${item.id}', 'description', this.value)">${item.description || ''}</textarea>
        </div>

        <div class="input-group">
            <label>Status</label>
            ${renderStatusSlider(item.id, item.status, false)}
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div id="wrapper-linkDOR" class="link-widget-wrapper">
                ${ui.renderLinkWidget(item.id, 'linkDOR', 'Definition of Ready', item.linkDOR)}
            </div>
            <div id="wrapper-linkDOD" class="link-widget-wrapper">
                ${ui.renderLinkWidget(item.id, 'linkDOD', 'Definition of Done', item.linkDOD)}
            </div>
            <div id="wrapper-linkOther" class="link-widget-wrapper">
                ${ui.renderLinkWidget(item.id, 'linkOther', 'Resources / Links', item.linkOther)}
            </div>
        </div>

        <div class="section-header">
            <div style="display:flex; align-items:center; gap:10px;">
                Work Logs
                <span style="font-size: 0.7rem; font-weight: normal; color: #666;">(${logs.length} visible)</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-small ${projectLogFilter.importantOnly ? 'btn-primary' : 'btn-outlined'}" 
                    onclick="toggleProjectLogFilter('${item.id}', 'important')">
                    ${projectLogFilter.importantOnly ? '‚òÖ Important Only' : '‚òÜ All Logs'}
                </button>
                <button class="btn btn-small btn-tonal" onclick="toggleProjectLogFilter('${item.id}', 'sort')">
                    ${projectLogFilter.sortAscending ? '‚¨ÜÔ∏è Oldest First' : '‚¨áÔ∏è Newest First'}
                </button>
            </div>
        </div>
        
        <div style="background: var(--md-sys-color-surface-variant); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <textarea id="new-log-input" placeholder="What are you working on? (Supports /table{...} and /program{...})" style="min-height: 80px; margin-bottom: 8px;"></textarea>
            <div style="text-align: right;">
                <button class="btn btn-primary btn-small" onclick="addWorkLog('${item.id}')">Log Entry</button>
            </div>
        </div>

        <div id="project-work-logs">
            ${logs.length === 0 ? '<p style="text-align:center; opacity:0.5; font-style:italic;">No logs match your filter.</p>' : ''}
            ${logs.map((log) => {
                // Find original index in the main array to ensure edits save to correct slot
                // We use referential equality since objects are passed by reference
                const originalIndex = (item.workLog || []).indexOf(log);
                
                return `
                <div class="work-log-entry ${log.isImportant ? 'important' : ''}" id="log-entry-${originalIndex}">
                    <div class="work-log-meta">
						<span>${new Date(log.timestamp).toLocaleString()} ${log.isLegacy ? '(Legacy Note)' : ''}</span>
						<div>
							 <button class="log-action-btn ${log.isImportant ? 'active-star' : ''}" onclick="toggleImportant('${item.id}', ${originalIndex})" title="Mark as Important">‚òÖ</button>
							 <button class="log-action-btn" onclick="enableEditLog('${item.id}', ${originalIndex})" title="Edit Note">‚úé</button>
							 <button class="log-action-btn" onclick="deleteWorkLog('${item.id}', ${originalIndex})" title="Delete Entry" style="color: var(--md-sys-color-error); margin-left: 8px;">‚úï</button>
						</div>
					</div>
                    <div class="work-log-content" id="log-content-${originalIndex}">${formatWorkLogContent(log.content)}</div>
                    <textarea id="log-edit-${originalIndex}" style="display:none; width:100%; border:1px solid #ccc; padding:8px;" onblur="saveLogEdit('${item.id}', ${originalIndex}, this.value)">${log.content}</textarea>
                </div>
            `}).join('')}
        </div>

        <div class="section-header">To-Do's</div>
        <div id="todo-list">
            ${(item.todos || []).map((t, idx) => `
                <div class="todo-card ${t.done ? 'done' : ''}">
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="let todos = store.get('projects', '${item.id}').todos; todos[${idx}].done = this.checked; updateField('projects', '${item.id}', 'todos', todos)">
                    <input type="text" class="table-inline-input" value="${t.text}" style="flex:1; border-bottom: none !important;" onchange="let todos = store.get('projects', '${item.id}').todos; todos[${idx}].text = this.value; updateField('projects', '${item.id}', 'todos', todos)">
                    <button class="btn btn-danger btn-small" style="height:28px; width:28px; padding:0" onclick="removeSubItem('projects', '${item.id}', 'todos', ${idx})">‚úï</button>
                </div>
            `).join('')}
        </div>
        <button class="btn btn-tonal btn-small" style="margin-top:8px" onclick="addSubItem('projects', '${item.id}', 'todos', {text:'', done:false, createdAt: new Date().toISOString()})">+ Add Task Card</button>

        <div class="section-header">Linked Tables</div>
        <div class="card-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
            ${(item.linkedTables || []).map((t, idx) => renderReferenceCard('projects', item.id, 'linkedTables', idx, t, 'tables')).join('')}
        </div>
        <button class="btn btn-tonal btn-small" style="margin-top:12px" onclick="addListItem('projects', '${item.id}', 'linkedTables')">+ Link Table</button>

        <div class="section-header">Linked Programs</div>
        <div class="card-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
             ${(item.linkedPrograms || []).map((p, idx) => renderReferenceCard('projects', item.id, 'linkedPrograms', idx, p, 'programs')).join('')}
        </div>
        <button class="btn btn-tonal btn-small" style="margin-top:12px" onclick="addListItem('projects', '${item.id}', 'linkedPrograms')">+ Link Program</button>
    `;
}

// Helper to render the Link inputs
function renderLinkInput(id, label, field, value) {
    if (value) {
        // READ MODE: Display clickable link + Pencil Button
        return `
            <div class="input-group">
                <label>${label}</label>
                <div style="display:flex; gap:8px; align-items: center; background: var(--md-sys-color-surface-variant); padding: 8px; border-radius: 4px; border-bottom: 1px solid var(--md-sys-color-outline);">
                    <a href="${value}" target="_blank" style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color:var(--md-sys-color-primary); font-weight:bold; text-decoration: underline;">${value}</a>
                    <button class="btn btn-icon-only btn-tonal" onclick="ui.editProjectLink('${id}', '${field}')" title="Edit Link">‚úé</button>
                </div>
            </div>
        `;
    } else {
        // EDIT MODE (Empty): Display Input field
        return `
            <div class="input-group">
                <label>${label}</label>
                <div style="display:flex; gap:4px;">
                    <input type="text" placeholder="https://..." 
                        onchange="updateField('projects', '${id}', '${field}', this.value)">
                </div>
            </div>
        `;
    }
}

// 5. MAILBOX
function renderMailboxDetail(item) {
    let logs = item.workLog || [];
    // Sort Newest First
    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    const isSolved = item.status === 'Solved';
    
    return `
         <div style="display:flex; justify-content:space-between; align-items:center; margin-right: 80px;">
            <h1>${item.subject}</h1>
            <div style="text-align:right">
                 ${isSolved ? '<span class="chip" style="background:var(--status-done);">SOLVED</span>' : '<span class="chip" style="background:var(--md-sys-color-primary);">OPEN</span>'}
            </div>
        </div>
        <div style="font-size:0.9rem; color:var(--md-sys-color-secondary); margin-bottom:1rem">From: <strong>${item.sender}</strong></div>

        <div class="input-group">
            <label>Status (Open ‚ü∑ Solved)</label>
            <div class="status-slider-container">
                <div class="status-slider-label"><span>Open</span><span>Solved</span></div>
                <input type="range" min="0" max="1" value="${isSolved ? 1 : 0}" class="status-slider" 
                    oninput="updateField('mailbox', '${item.id}', 'status', this.value == 1 ? 'Solved' : 'Open'); document.querySelector('.chip').outerHTML = this.value == 1 ? '<span class=\\'chip\\' style=\\'background:var(--status-done);\\'>SOLVED</span>' : '<span class=\\'chip\\' style=\\'background:var(--md-sys-color-primary);\\'>OPEN</span>'">
            </div>
        </div>

        <div class="input-group">
            <label>Keywords</label>
            <div style="margin-bottom:8px">
                ${(item.keywords || []).map((k, idx) => `
                    <span class="chip chip-keyword chip-removable" onclick="removeSubItem('mailbox', '${item.id}', 'keywords', ${idx})">${k} ‚úï</span>
                `).join('')}
            </div>
            <div style="display:flex; gap:8px;">
                <input type="text" id="addKwInput" placeholder="Add keyword" onkeydown="if(event.key==='Enter') addMailboxKeyword('${item.id}')">
                <button class="btn btn-tonal btn-small" onclick="addMailboxKeyword('${item.id}')">Add</button>
            </div>
        </div>

        <div class="section-header">
            Work Notes
            <span style="font-size: 0.7rem; font-weight: normal; color: #666;">Log your solution or progress</span>
        </div>
        
        <div style="background: var(--md-sys-color-surface-variant); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <textarea id="mail-log-input" placeholder="Notes... (Supports /table{...}, /program{...} and /query{...})" style="min-height: 80px; margin-bottom: 8px;"></textarea>
            <div style="text-align: right;">
                <button class="btn btn-primary btn-small" onclick="addMailboxLog('${item.id}')">Log Note</button>
            </div>
        </div>

        <div id="mailbox-logs">
            ${logs.map((log, index) => `
                <div class="work-log-entry ${log.isImportant ? 'important' : ''}">
                    <div class="work-log-meta">
                        <span>${new Date(log.timestamp).toLocaleString()}</span>
                        <div>
                             <button class="log-action-btn ${log.isImportant ? 'active-star' : ''}" onclick="ui.toggleMailboxImportant('${item.id}', ${index})" title="Mark as Important">‚òÖ</button>
                             <button class="log-action-btn" onclick="ui.enableEditMailboxLog('${item.id}', ${index})" title="Edit Note">‚úé</button>
                             <button class="log-action-btn" onclick="ui.deleteMailboxLog('${item.id}', ${index})" title="Delete Entry" style="color: var(--md-sys-color-error); margin-left: 8px;">‚úï</button>
                        </div>
                    </div>
                    <div class="work-log-content" id="mail-log-content-${index}">${formatWorkLogContent(log.content)}</div>
                    <textarea id="mail-log-edit-${index}" style="display:none; width:100%; border:1px solid #ccc; padding:8px;" onblur="ui.saveMailboxLogEdit('${item.id}', ${index}, this.value)">${log.content}</textarea>
                </div>
            `).join('')}
        </div>
    `;
}

function addMailboxKeyword(id) {
    const input = document.getElementById('addKwInput');
    if (!input || !input.value.trim()) return;
    const val = input.value.trim();

    const item = store.get('mailbox', id);
    if (!item.keywords) item.keywords = [];
    item.keywords.push(val);
    
    store.update('mailbox', id, { keywords: item.keywords });
    router.renderDetail('mailbox', id);
}

function addMailboxLog(id) {
    const input = document.getElementById('mail-log-input');
    const text = input.value.trim();
    if (!text) return;

    const item = store.get('mailbox', id);
    const logs = item.workLog || [];
    
    logs.push({
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        content: text
    });

    store.update('mailbox', id, { workLog: logs });
    router.renderDetail('mailbox', id);
}

function renderStatusSlider(projectId, currentStatus, stopProp = false) {
    const steps = ['ANA', 'DEV', 'APB', 'DONE'];
    let val = steps.indexOf(currentStatus);
    if (val === -1) val = 0;

    const clickAttr = stopProp ? 'onclick="event.stopPropagation()"' : '';

    return `
        <div class="status-slider-container" ${clickAttr}>
            <div class="status-slider-label">
                <span style="color:var(--status-ana)">ANA</span>
                <span style="color:var(--status-dev)">DEV</span>
                <span style="color:var(--status-apb)">APB</span>
                <span style="color:var(--status-done)">DONE</span>
            </div>
            <input type="range" min="0" max="3" value="${val}" class="status-slider" 
                oninput="updateProjectStatus('${projectId}', this.value)">
        </div>
    `;
}

function updateProjectStatus(projectId, val) {
    const steps = ['ANA', 'DEV', 'APB', 'DONE'];
    store.update('projects', projectId, { status: steps[parseInt(val)] });
}

function deleteObject(type, id) {
    if(confirm('Are you sure you want to delete this object? This cannot be undone.')) {
        store.delete(type, id);
        router.navigate(type);
    }
}

function addWorkLog(projectId) {
    const input = document.getElementById('new-log-input');
    const text = input.value.trim();
    if (!text) return;

    const item = store.get('projects', projectId);
    const logs = item.workLog || [];
    
    logs.push({
        id: Date.now().toString(),
        timestamp: new Date().toISOString(),
        content: text,
        isImportant: false // Default new logs to not important
    });

    store.update('projects', projectId, { workLog: logs });
    
    if (item.notes) {
        store.update('projects', projectId, { notes: '' });
    }

    router.renderDetail('projects', projectId);
}
function deleteWorkLog(projectId, index) {
    if(!confirm('Are you sure you want to permanently delete this work log entry?')) return;
    
    const item = store.get('projects', projectId);
    // Copy the array to avoid direct mutation issues
    const logs = [...(item.workLog || [])];
    
    // Remove the item at the specific index
    logs.splice(index, 1);
    
    store.update('projects', projectId, { workLog: logs });
    
    // Re-render to show changes
    router.renderDetail('projects', projectId);
}
function toggleImportant(projectId, index) {
    const item = store.get('projects', projectId);
    let logs = [...item.workLog];
    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    logs[index].isImportant = !logs[index].isImportant;
    store.update('projects', projectId, { workLog: logs });
    router.renderDetail('projects', projectId);
}

function enableEditLog(projectId, index) {
    document.getElementById(`log-content-${index}`).style.display = 'none';
    const ta = document.getElementById(`log-edit-${index}`);
    ta.style.display = 'block';
    ta.focus();
}

function saveLogEdit(projectId, index, value) {
    const item = store.get('projects', projectId);
    let logs = [...item.workLog];
    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    logs[index].content = value;
    store.update('projects', projectId, { workLog: logs });
    router.renderDetail('projects', projectId);
}

// 5. LOG WORK (Timer)
let timerInterval = null;
let currentProjectId = null;
let startTime = null;
let lastSaveTime = null; // Track save time
let pendingDeleteId = null; // For Quick Link deletion
let currentReminderId = null; // For Alert dismissal

// --- STATUS BAR LOGIC ---
function updateStatusBar() {
    // 1. Update Timer Section
    const timerSection = document.getElementById('sb-timer-section');
    if (currentProjectId) {
        const project = store.get('projects', currentProjectId);
        if (project) {
            timerSection.innerHTML = `
                <span class="rec-dot active"></span>
                <span style="color:var(--md-sys-color-primary)">${project.name}</span>
                <button class="status-btn-stop" onclick="stopTimer()">
                    <span>‚èπ</span> Stop
                </button>
            `;
        }
    } else {
        timerSection.innerHTML = `
            <span class="rec-dot"></span>
            <span style="color:var(--md-sys-color-secondary); font-size:0.85rem; font-style:italic;">no active time logging...</span>
        `;
    }

    // 2. Update Todo Count
    const projects = store.getAll('projects');
    let todoCount = 0;
    projects.forEach(p => {
        if(p.todos) {
            todoCount += p.todos.filter(t => !t.done).length;
        }
    });
    // Add Global Todos
    const globalTodos = store.getAll('globalTodos');
    todoCount += globalTodos.filter(t => !t.done).length;
    
    document.getElementById('sb-todo-count').innerText = `${todoCount} Open`;

    // 3. Update Last Save Time
    const saveEl = document.getElementById('sb-last-save');
    if (lastSaveTime) {
        const diffSec = Math.floor((Date.now() - lastSaveTime) / 1000);
        if (diffSec < 60) {
            saveEl.innerText = 'Just now';
        } else {
            const mins = Math.floor(diffSec / 60);
            saveEl.innerText = `${mins} min${mins !== 1 ? 's' : ''} ago`;
        }
    } else {
        saveEl.innerText = 'Never';
    }

    // 4. Check Reminders
    checkReminders();
}

function checkReminders() {
    const now = new Date();
    const reminders = store.getAll('reminders');
    const alertModal = document.getElementById('reminderAlertModal');
    
    // Only check if modal isn't already open
    if (alertModal.open) return;

    for (const rem of reminders) {
        if (!rem.dismissed) {
            const due = new Date(rem.datetime);
            if (now >= due) {
                // Trigger Alarm
                currentReminderId = rem.id;
                document.getElementById('reminderAlertText').innerText = rem.text;
                alertModal.showModal();
                break; // One at a time
            }
        }
    }
}

// Start global status loop
setInterval(updateStatusBar, 1000);
updateStatusBar(); // Init

function renderLogWork() {
    // 1. Separate System vs Regular Projects
    const allProjects = store.getAll('projects').filter(p => p.status !== 'DONE' || p.isSystem);
    
    const systemIds = ['mailbox_fixed', 'incident_fixed', 'overhead_fixed'];
    const systemProjects = allProjects.filter(p => systemIds.includes(p.id));
    
    // Sort system projects
    systemProjects.sort((a, b) => systemIds.indexOf(a.id) - systemIds.indexOf(b.id));

    const userProjects = allProjects.filter(p => !systemIds.includes(p.id));

    const mainEl = document.getElementById('mainContent');
    const activeProject = currentProjectId ? store.get('projects', currentProjectId) : null;
    
    const sysIcons = { 'mailbox_fixed': 'üì¨', 'incident_fixed': 'üî•', 'overhead_fixed': '‚òï' };

    // HTML Construction
    let html = `
        <div class="header-row">
            <h1 class="page-title">Log Work</h1>
            <div style="display:flex; gap: 10px; align-items:center;">
                <div style="display:flex; background:var(--md-sys-color-surface-variant); padding:4px; border-radius:20px;">
                    <button class="btn btn-small ${logWorkViewMode === 'week' ? 'btn-primary' : 'btn-ghost'}" 
                        style="border-radius:16px;" 
                        onclick="logWorkViewMode='week'; renderLogWork()">This Week</button>
                    <button class="btn btn-small ${logWorkViewMode === 'all' ? 'btn-primary' : 'btn-ghost'}" 
                        style="border-radius:16px;" 
                        onclick="logWorkViewMode='all'; renderLogWork()">All Time</button>
                </div>
                ${currentProjectId ? `<button class="btn btn-danger" onclick="stopTimer()">Stop Timer</button>` : ''}
            </div>
        </div>

        <div class="detail-container" style="text-align:center; margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between; padding: 1.5rem 3rem;">
            <div style="text-align: left;">
                 <p style="margin:0; opacity: 0.7; font-weight: 500; font-size: 0.9rem; text-transform: uppercase;">Current Session</p>
                 <div style="font-size: 1.2rem; font-weight: bold; margin-top: 5px;">
                    ${currentProjectId ? activeProject.name : 'No Active Timer'}
                 </div>
            </div>
            <div id="timerDisplay" class="timer-display" style="margin: 0;">00:00:00</div>
        </div>

        <h3 style="margin-bottom: 1rem; color: var(--md-sys-color-primary)">Quick Actions</h3>
        <div class="fixed-ticket-container">
            ${systemProjects.map(p => {
                const isActive = currentProjectId === p.id;
                // LOGIC SWITCH: Check mode
                const timeValue = logWorkViewMode === 'week' ? getProjectTimeForCurrentWeek(p.id) : p.timeSpent;
                const formattedTime = formatDuration(timeValue);
                
                return `
                    <div class="fixed-ticket-card ${isActive ? 'active-timer' : ''}" onclick="handleProjectCardClick('${p.id}')">
                        <div class="fixed-ticket-actions">
                            <button class="btn btn-icon-only btn-tonal" onclick="event.stopPropagation(); router.navigate('projects', '${p.id}')">‚ûö</button>
                        </div>
                        <div class="fixed-ticket-title">
                            <span style="font-size: 1.5rem;">${sysIcons[p.id] || 'üìã'}</span>
                            <span>${p.name}</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.75rem; opacity: 0.8; text-transform: uppercase;">${logWorkViewMode === 'week' ? 'This Week' : 'Total Time'}</div>
                            <div class="fixed-ticket-time">${formattedTime}</div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 6px;">
                             ${isActive ? '<span class="rec-dot active" style="background: white;"></span> Recording...' : '‚ñ∂ Click to Start'}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>

        <h3 style="margin-bottom: 1rem; color: var(--md-sys-color-on-surface-variant); margin-top: 2rem;">Project Tickets</h3>
        <div class="card-grid">
            ${userProjects.map(p => {
                const isActive = currentProjectId === p.id;
                // LOGIC SWITCH: Check mode
                const timeValue = logWorkViewMode === 'week' ? getProjectTimeForCurrentWeek(p.id) : p.timeSpent;
                const formattedTime = formatDuration(timeValue);

                return `
                    <div class="card ${isActive ? 'active-timer' : ''} project-card status-border-${p.status}" onclick="handleProjectCardClick('${p.id}')">
						<div style="display:flex; justify-content: space-between; align-items: flex-start;">
							<h3 style="margin:0; color: var(--md-sys-color-on-surface);">
								${p.name}
							</h3>
							<div style="display:flex; gap: 4px; align-items: center;">
								<button class="btn btn-tonal btn-icon-only" title="Adjust Time" onclick="adjustTime('${p.id}', event)" style="width:24px; height:24px;">¬±</button>
								<span class="chip status-${p.status}">${p.status}</span>
							</div>
						</div>
						
						<p style="margin-top: 10px;">${p.description || 'No description'}</p>
                        
                        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px dashed var(--md-sys-color-outline-variant); font-size: 0.85rem; color: var(--md-sys-color-primary);">
                             <strong>${logWorkViewMode === 'week' ? 'Week' : 'Total'}:</strong> ${formattedTime}
                        </div>
						
						<div style="margin-top: 8px; font-weight: bold; color: var(--md-sys-color-primary)">
							${isActive ? '‚óè Recording...' : 'Click to start'}
						</div>
					</div>
                `;
            }).join('')}
             ${userProjects.length === 0 ? '<p style="grid-column: 1/-1; text-align: center; opacity: 0.5;">No active projects.</p>' : ''}
        </div>
    `;
    mainEl.innerHTML = html;
    
    if (currentProjectId && startTime) {
        updateTimerDisplay();
    }
}

function handleProjectCardClick(id) {
    if (currentProjectId === id) {
        stopTimer();
    } else {
        if (currentProjectId) {
            stopTimer(false); 
        }
        startTimer(id);
    }
}

function startTimer(projectId) {
    currentProjectId = projectId;
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimerDisplay, 1000);
    updateStatusBar(); // Update UI immediately
    renderLogWork();
}

function updateTimerDisplay() {
    if(!startTime) return;
    const diff = Date.now() - startTime;
    const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
    const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
    const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
    const el = document.getElementById('timerDisplay');
    if(el) el.innerText = `${h}:${m}:${s}`;
}

function stopTimer(shouldRefresh = true) {
    if (!currentProjectId) return;

    // --- CHECK FOR SYSTEM ID ---
    const systemIds = ['mailbox_fixed', 'incident_fixed', 'overhead_fixed'];
    if (systemIds.includes(currentProjectId)) {
        // Open Modal instead of stopping immediately
        ui.openSystemStopModal(currentProjectId);
        return;
    }
    const endTime = Date.now();
    const sessionDuration = endTime - startTime;
    
    // 1. Update Aggregate Time
    const project = store.get('projects', currentProjectId);
    const newTotal = (project.timeSpent || 0) + sessionDuration;
    store.update('projects', currentProjectId, { timeSpent: newTotal });
    
    // 2. Record Session for Dashboard (New)
    if (!store.data.workSessions) store.data.workSessions = [];
    store.data.workSessions.push({
        id: Date.now().toString(),
        projectId: currentProjectId,
        start: new Date(startTime).toISOString(),
        end: new Date(endTime).toISOString(),
        duration: sessionDuration
    });
    store.save(); // Persist session

    clearInterval(timerInterval);
    timerInterval = null;
    currentProjectId = null;
    startTime = null;
    
    updateStatusBar(); // Update UI immediately

    if (shouldRefresh) {
        // If we are on logwork page, refresh
        if (router.currentView === 'logwork') {
            renderLogWork();
        }
    }
	finalizeStopTimer(shouldRefresh);
}
function finalizeStopTimer(shouldRefresh = true, customDesc = null) {
    const endTime = Date.now();
    const sessionDuration = endTime - startTime;
    
    // 1. Update Aggregate Time
    const project = store.get('projects', currentProjectId);
    const newTotal = (project.timeSpent || 0) + sessionDuration;
    
    // 2. Add Log Entry if customDesc is provided (System Tickets)
    let logs = project.workLog || [];
    if (customDesc) {
        logs.push({
            id: Date.now().toString(),
            timestamp: new Date().toISOString(),
            content: customDesc,
            isImportant: false
        });
    }

    store.update('projects', currentProjectId, { 
        timeSpent: newTotal,
        workLog: logs
    });
    
    // 3. Record Session for Dashboard
    if (!store.data.workSessions) store.data.workSessions = [];
    store.data.workSessions.push({
        id: Date.now().toString(),
        projectId: currentProjectId,
        start: new Date(startTime).toISOString(),
        end: new Date(endTime).toISOString(),
        duration: sessionDuration
    });
    store.save();

    // Reset Globals
    clearInterval(timerInterval);
    timerInterval = null;
    currentProjectId = null;
    startTime = null;
    
    updateStatusBar();

    if (shouldRefresh) {
        if (router.currentView === 'logwork') {
            renderLogWork();
        }
    }
}
function adjustTime(projectId, event) {
    if (event) event.stopPropagation();
    ui.openAdjustModal(projectId);
}

/**
 * --- HELPER FUNCTIONS ---
 */
 function toggleFavorite(type, id) {
    const item = store.get(type, id);
    if (item) {
        // Toggle boolean
        const newVal = !item.favorite;
        store.update(type, id, { favorite: newVal });
        // Refresh List
        router.renderList(type);
    }
}
// Replace the existing getProjectTimeForCurrentWeek function
function getProjectTimeForCurrentWeek(projectId) {
    const now = new Date();
    const day = now.getDay(); 
    // Calculate Monday of the current week
    const diff = now.getDate() - day + (day == 0 ? -6 : 1); 
    const monday = new Date(now.setDate(diff));
    monday.setHours(0,0,0,0);
    
    const sessions = store.data.workSessions || [];
    
    return sessions.reduce((total, sess) => {
        const sessDate = new Date(sess.start);
        // Ensure we strictly check Project ID and Date range
        if (sess.projectId === projectId && sessDate >= monday) {
            // FIX: Wrap in Number() to prevent string concatenation (e.g. "100" + "100" = "100100")
            return total + Number(sess.duration || 0);
        }
        return total;
    }, 0);
}
function updateField(type, id, field, value) {
    store.update(type, id, { [field]: value });
    if(field === 'linkedTables' || field === 'linkedPrograms' || field === 'todos' || field === 'keywords') {
        router.renderDetail(type, id);
    }
}

function addListItem(type, id, field) {
    const item = store.get(type, id);
    const list = item[field] || [];
    list.push('');
    store.update(type, id, { [field]: list });
    router.renderDetail(type, id);
}

function updateSubItemValue(type, id, field, index, value) {
    const item = store.get(type, id);
    const list = [...item[field]];
    list[index] = value;
    store.update(type, id, { [field]: list });
    router.renderDetail(type, id);
}

function addSubItem(type, id, field, emptyObj) {
    const item = store.get(type, id);
    const list = item[field] || [];
    list.push(emptyObj);
    store.update(type, id, { [field]: list });
    router.renderDetail(type, id);
}

function updateSubField(type, id, arrayName, index, key, value) {
    const item = store.get(type, id);
    const list = item[arrayName];
    list[index][key] = value;
    store.update(type, id, { [arrayName]: list });
}

function removeSubItem(type, id, arrayName, index) {
    const item = store.get(type, id);
    const list = item[arrayName];
    list.splice(index, 1);
    store.update(type, id, { [arrayName]: list });
    router.renderDetail(type, id);
}

function formatWorkLogContent(text) {
    if(!text) return '';
    
    // 1. Basic HTML Escaping
    let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    // 2. Split text by the /query{...} pattern (multiline supported)
    // The regex captures the full query tag so we can process it in the loop
    const parts = safeText.split(/(\/query\{[\s\S]*?\})/g);
    
    // 3. Process each part
    return parts.map(part => {
        if (part.startsWith('/query{') && part.endsWith('}')) {
            // --- HANDLE QUERY BLOCK ---
            // Remove /query{ and }
            const content = part.slice(7, -1); 
            // Return formatted box. CSS 'white-space: pre-wrap' handles the newlines.
            return `<div class="query-box">${content}</div>`;
        } else {
            // --- HANDLE NORMAL TEXT ---
            // Convert newlines to <br> for normal text
            let processed = part.replace(/\n/g, "<br>");
            
            // Link Tables
            processed = processed.replace(/\/table\{([^}]+)\}/g, (match, name) => {
                const found = store.findByName('tables', name);
                if (found) {
                    return `<span class="smart-ref found" onclick="router.navigate('tables', '${found.id}')">üõ¢Ô∏è ${name}</span>`;
                } else {
                    return `<span class="smart-ref missing" style="cursor:pointer;" title="Table '${name}' not found. Click to create." onclick="ui.openCreateModal('tables', '${name}')">‚ö†Ô∏è ${name}</span>`;
                }
            });
            
            // Link Programs
            processed = processed.replace(/\/program\{([^}]+)\}/g, (match, name) => {
                const found = store.findByName('programs', name);
                if (found) {
                    return `<span class="smart-ref found" onclick="router.navigate('programs', '${found.id}')">üì¶ ${name}</span>`;
                } else {
                    return `<span class="smart-ref missing" style="cursor:pointer;" title="Program '${name}' not found. Click to create." onclick="ui.openCreateModal('programs', '${name}')">‚ö†Ô∏è ${name}</span>`;
                }
            });
            
            return processed;
        }
    }).join('');
}
// --- PROJECT LOG FILTER STATE ---
let projectLogFilter = {
    importantOnly: false,
    sortAscending: false // Default: Newest first
};

function toggleProjectLogFilter(projectId, type) {
    if (type === 'important') projectLogFilter.importantOnly = !projectLogFilter.importantOnly;
    if (type === 'sort') projectLogFilter.sortAscending = !projectLogFilter.sortAscending;
    // Re-render the view to apply changes
    router.renderDetail('projects', projectId);
}

// Modal Helper Globals
let currentModalKeywords = [];
let adjustProjectId = null; // Track which project is being adjusted

function addModalKeyword() {
    const input = document.getElementById('keywordIn');
    const val = input.value.trim();
    if(val) {
        currentModalKeywords.push(val);
        input.value = '';
        renderModalKeywords();
    }
    input.focus();
}

function renderModalKeywords() {
    const container = document.getElementById('keywordListDisplay');
    container.innerHTML = currentModalKeywords.map((k, idx) => `
        <span class="chip chip-keyword chip-removable" onclick="currentModalKeywords.splice(${idx}, 1); renderModalKeywords()">${k} ‚úï</span>
    `).join('');
}
/**
 * --- CONFLUENCE GENERATOR ---
 */
/**
 * --- CONFLUENCE GENERATOR (UPDATED) ---
 */
function getConfluenceHTML(type, id) {
    const item = store.get(type, id);
    if (!item) return '';

    const formatDate = (iso) => new Date(iso).toLocaleDateString() + ' ' + new Date(iso).toLocaleTimeString();
    
    // Macro Helper: Status Lozenge
    const renderStatus = (status, colorOverride = null) => {
        const map = { 
            'ANA': 'Blue', 'DEV': 'Yellow', 'APB': 'Orange', 'DONE': 'Green',
            'Open': 'Red', 'Solved': 'Green' 
        };
        const color = colorOverride || map[status] || 'Grey';
        return `{status:colour=${color}|title=${status}}`;
    };

    let m = ''; // The markup string

    // --- 1. PROGRAMS ---
    if (type === 'programs') {
        m += `h1. üì¶ ${item.longName} (${item.shortName})\n\n`;
        m += `{info:title=Summary}\n${safeWiki(item.shortDescription) || 'No description provided.'}\n{info}\n\n`;

        if (item.flow) {
            m += `{panel:title=Program Flow|borderStyle=solid|borderColor=#ccc|bgColor=#f9f9f9}\n`;
            m += `{noformat}\n${item.flow}\n{noformat}\n`; 
            m += `{panel}\n\n`;
        }

        m += `{section}\n{column:width=50%}\n`;
        m += `h3. Related Tables\n`;
        if (item.linkedTables?.length) item.linkedTables.forEach(t => m += `* üõ¢Ô∏è ${t}\n`);
        else m += `_None_\n`;
        
        m += `{column}\n{column:width=50%}\n`;
        m += `h3. Related Programs\n`;
        if (item.linkedPrograms?.length) item.linkedPrograms.forEach(p => m += `* üì¶ ${p}\n`);
        else m += `_None_\n`;
        m += `{column}\n{section}\n`;
    } 
    
    // --- 2. TABLES ---
    else if (type === 'tables') {
        m += `h1. üõ¢Ô∏è Table: ${item.name}\n\n`;
        m += `{quote}${safeWiki(item.description) || 'No description.'}{quote}\n\n`;

        if (item.fields?.length) {
            m += `h3. Field Definitions\n`;
            m += `|| Name || Description || Example || Comments ||\n`;
            item.fields.forEach(f => {
                m += `| *${safeWiki(f.name)}* | ${safeWiki(f.desc)} | {{${safeWiki(f.ex)}}} | ${safeWiki(f.comm)} |\n`;
            });
            m += `\n`;
        }

        if (item.links?.length) {
            m += `{panel:title=Relationships|titleBGColor=#eae6ff|borderColor=#6750a4}\n`;
            item.links.forEach(l => {
                const arrow = l.bidirectional ? '‚Üî' : '‚Üí';
                m += `* ${arrow} *${l.toTable}*: {{${l.join}}}\n`;
            });
            m += `{panel}\n`;
        }
    } 
    
    // --- 3. PROJECTS (UPDATED FOR LISTS) ---
    else if (type === 'projects') {
        m += `h1. üöÄ Project: ${item.name}\n\n`;
        m += `|| Status || Time Logged || Created ||\n`;
        m += `| ${renderStatus(item.status)} | *${formatDuration(item.timeSpent)}* | ${formatDate(item.createdAt)} |\n\n`;

        m += `{panel:title=Description|titleBGColor=#f4f5f7|borderColor=#ccc}\n`;
        m += `${formatMarkupContent(item.description) || '_No description._'}\n`;
        m += `{panel}\n\n`;

        if(item.linkDOR || item.linkDOD || item.linkOther) {
            m += `h3. üîó References\n`;
            if(item.linkDOR) m += `* [Definition of Ready|${item.linkDOR}]\n`;
            if(item.linkDOD) m += `* [Definition of Done|${item.linkDOD}]\n`;
            if(item.linkOther) m += `* [External Resource|${item.linkOther}]\n`;
            m += `\n`;
        }

        if (item.todos?.length) {
            m += `h3. ‚úÖ Pending Tasks\n`;
            item.todos.filter(t => !t.done).forEach(t => m += `* ${formatMarkupContent(t.text)}\n`);
            m += `\n`;
        }

        if (item.workLog?.length) {
            m += `{expand:title=View Work Log History (${item.workLog.length} entries)}\n`;
            const sorted = [...item.workLog].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            sorted.forEach(log => {
                const date = formatDate(log.timestamp);
                const icon = log.isImportant ? '‚≠ê ' : '';
                m += `* *${date}* ${icon}\n`;
                // CHANGED: Use {quote} block to ensure multi-line lists inside notes render correctly
                m += `{quote}\n${formatMarkupContent(log.content)}\n{quote}\n`;
                m += `----\n`;
            });
            m += `{expand}\n\n`;
        }
    } 
    
    // --- 4. QUERIES (UPDATED FOR COLORS) ---
    else if (type === 'queries') {
        const indMap = { 'R': 'Read', 'C': 'Create', 'U': 'Update', 'D': 'Delete' };
        // Define colors: Green for Read, Yellow for Create, Red for Update/Delete
        const colorMap = { 'R': 'Green', 'C': 'Yellow', 'U': 'Red', 'D': 'Red' };
        
        const label = indMap[item.updateIndicator] || item.updateIndicator;
        const color = colorMap[item.updateIndicator] || 'Grey';

        m += `h1. üîç Query: ${item.name}\n\n`;
        // CHANGED: Use renderStatus with explicit color override
        m += `*Type:* ${renderStatus(label, color)}\n\n`;
        
        m += `{code:language=sql|title=SQL Query|theme=Midnight}\n`;
        m += `${item.query || ''}\n`;
        m += `{code}\n\n`;
        
        if (item.paramDescs && Object.keys(item.paramDescs).length > 0) {
             m += `h3. Parameters\n`;
             m += `|| Parameter || Description ||\n`;
             Object.entries(item.paramDescs).forEach(([key, val]) => {
                 m += `| :${key} | ${val} |\n`;
             });
        }
    }

    // --- 5. MAILBOX ---
    else if (type === 'mailbox') {
        const isSolved = item.status === 'Solved';
        const containerMacro = isSolved ? 'info' : 'note';
        
        m += `h1. ‚úâÔ∏è ${item.subject}\n\n`;
        m += `{${containerMacro}:title=Status: ${item.status}}\n`;
        m += `*Sender:* ${item.sender}\n`;
        if(item.keywords?.length) m += `*Keywords:* ${item.keywords.join(', ')}\n`;
        m += `{${containerMacro}}\n\n`;

        m += `{panel:title=Discussion & Notes}\n`;
        const sorted = [...(item.workLog||[])].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
        sorted.forEach(log => {
            m += `* *${formatDate(log.timestamp)}*: ${formatMarkupContent(log.content)}\n`;
        });
        m += `{panel}`;
    }

    return m;
}
function renderConfluencePanel() {
    // 1. Initial State
    if (!window.confState) window.confState = { type: 'projects', id: '' };

    const types = [
        { val: 'projects', label: 'Projects' },
        { val: 'tables', label: 'Tables' },
        { val: 'programs', label: 'Programs' },
        { val: 'queries', label: 'Queries' },
        { val: 'mailbox', label: 'Mailbox' }
    ];

    const items = store.getAll(window.confState.type);
    const hasSelection = !!window.confState.id;
    
    // Generate Markup
    const markupContent = hasSelection 
        ? getConfluenceHTML(window.confState.type, window.confState.id) 
        : 'Select an object to generate Wiki Markup.';

    const html = `
        <div class="header-row">
            <h1 class="page-title">Confluence Export</h1>
        </div>

        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem; height: calc(100vh - 180px);">
            
            <div class="card" style="height: 100%; display: flex; flex-direction: column; border-left: 5px solid #205081;">
                <h3 style="margin-top:0; color:var(--md-sys-color-primary); border-bottom:1px solid var(--md-sys-color-outline-variant); padding-bottom:12px;">
                    Configuration
                </h3>
                
                <div class="input-group" style="margin-top: 1rem;">
                    <label>Source Type</label>
                    <select onchange="window.confState.type = this.value; window.confState.id = ''; router.renderList('confluence')"
                        style="background: var(--md-sys-color-surface-variant);">
                        ${types.map(t => `<option value="${t.val}" ${window.confState.type === t.val ? 'selected' : ''}>${t.label}</option>`).join('')}
                    </select>
                </div>

                <div class="input-group" style="flex: 1; display: flex; flex-direction: column;">
                    <label>Select Object</label>
                    <select onchange="window.confState.id = this.value; router.renderList('confluence')" 
                        size="10" 
                        style="flex: 1; background: var(--md-sys-color-surface-variant); padding: 8px;">
                        ${items.map(i => `<option value="${i.id}" ${window.confState.id === i.id ? 'selected' : ''} style="padding: 4px;">${i.name || i.shortName || i.subject}</option>`).join('')}
                    </select>
                </div>

                <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--md-sys-color-outline-variant);">
                     <button class="btn btn-primary" style="width:100%; height: 50px; font-size: 1.1rem;" 
                        onclick="copyConfluencePreview()" ${!hasSelection ? 'disabled' : ''}>
                        ${hasSelection ? 'üìã Copy Wiki Markup' : 'Select an Item'}
                    </button>
                    <div style="text-align:center; font-size:0.75rem; color:var(--md-sys-color-secondary); margin-top:8px; line-height: 1.4;">
                        Use <strong>Ctrl + Shift + D</strong> in Confluence<br>to paste this Markup.
                    </div>
                </div>
            </div>

            <div style="position: relative; display: flex; flex-direction: column;">
                <div style="background: #205081; color: white; padding: 10px 16px; border-radius: 8px 8px 0 0; font-weight: bold; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                    <span>WIKI MARKUP PREVIEW</span>
                    ${hasSelection ? '<span style="font-size:0.8em; opacity:0.8; font-family:monospace;">Ready to Copy</span>' : ''}
                </div>
                
                <textarea id="confluencePreview" readonly
                     style="background: #f4f5f7; color: #172b4d; flex: 1; resize: none; padding: 20px; font-family: monospace; font-size: 0.9rem;
                            border: 1px solid var(--md-sys-color-outline-variant); border-top: none; border-radius: 0 0 8px 8px; outline: none;">${markupContent}</textarea>
            </div>
        </div>
    `;

    document.getElementById('mainContent').innerHTML = html;
}

// Helper to handle the copy action
function copyConfluencePreview() {
    const el = document.getElementById('confluencePreview');
    if (!el) return;
    
    el.select();
    el.setSelectionRange(0, 99999); // For mobile devices

    try {
        navigator.clipboard.writeText(el.value).then(() => {
            const toast = document.getElementById("toast");
            toast.innerText = "Markup copied! Use Ctrl+Shift+D in Confluence.";
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        });
    } catch(err) {
        // Fallback
        document.execCommand('copy');
        alert("Copied!");
    }
}
/**
 * --- CONFLUENCE MARKUP UTILS ---
 */
 
function safeWiki(str) {
    if (!str) return '';
    // Escape pipes and curly braces which are control characters in Wiki Markup
    return str.replace(/\|/g, '\\|').replace(/\{/g, '\\{').replace(/\}/g, '\\}');
}

function formatMarkupContent(text) {
    if(!text) return '';
    
    // 1. Escape special Wiki characters first (this turns '{' into '\{')
    let res = safeWiki(text);
    
    // 2. Handle /query{...} -> {code} block
    // Since safeWiki ran, we look for escaped brackets: /query\{ ... \}
    // [\s\S]*? matches any character including newlines, non-greedy
    res = res.replace(/\/query\\\{([\s\S]*?)\\\}/g, (match, codeContent) => {
        // We un-escape the content inside the code block so the query looks clean
        const rawCode = codeContent.replace(/\\\{/g, '{').replace(/\\\}/g, '}').replace(/\\\|/g, '|');
        return `\n{code:language=sql|title=SQL Query|theme=Midnight}\n${rawCode}\n{code}\n`;
    });
    
    // 3. Convert smart tags to Bold Confluence Text
    res = res.replace(/\/table\\\{([^}]+)\\\}/g, ' *üõ¢Ô∏è $1* ');
    res = res.replace(/\/program\\\{([^}]+)\\\}/g, ' *üì¶ $1* ');
    
    return res;
}
const ui = {
    // --- MAILBOX LOG ACTIONS ---
    toggleMailboxImportant: (id, index) => {
        const item = store.get('mailbox', id);
        if (!item.workLog) return;
        
        // Ensure array copy
        const logs = [...item.workLog];
        // Sort to match view (Newest First)
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        // Toggle
        logs[index].isImportant = !logs[index].isImportant;
        
        // We must re-sort back to original chronological order if that's how you save, 
        // OR just save the modified sorted array. 
        // Safest is to find the exact object by ID in the original array if possible, 
        // but since we sort in view, let's just update the specific item found by index in the sorted view.
        // NOTE: A better approach for data integrity is finding by ID.
        // Let's stick to the Project pattern for consistency:
        
        // Update the main store
        store.update('mailbox', id, { workLog: logs });
        router.renderDetail('mailbox', id);
    },

    enableEditMailboxLog: (id, index) => {
        document.getElementById(`mail-log-content-${index}`).style.display = 'none';
        const ta = document.getElementById(`mail-log-edit-${index}`);
        ta.style.display = 'block';
        ta.focus();
    },

    saveMailboxLogEdit: (id, index, value) => {
        const item = store.get('mailbox', id);
        let logs = [...item.workLog];
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        logs[index].content = value;
        store.update('mailbox', id, { workLog: logs });
        router.renderDetail('mailbox', id);
    },

    deleteMailboxLog: (id, index) => {
        if(!confirm('Delete this note permanently?')) return;
        const item = store.get('mailbox', id);
        let logs = [...item.workLog];
        
        // We need to remove the correct item. Since view is sorted, we delete by index of the sorted view
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        logs.splice(index, 1);
        
        store.update('mailbox', id, { workLog: logs });
        router.renderDetail('mailbox', id);
    },

    // --- CONFLUENCE DIRECT COPY ---
    copyConfluenceObject: (type, id) => {
        const markup = getConfluenceHTML(type, id);
        if (!markup) {
            alert("Error generating markup.");
            return;
        }

        // Copy to clipboard
        const el = document.createElement('textarea');
        el.value = markup;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);

        // Feedback
        const btn = document.getElementById('btn-conf-copy');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span>‚úÖ</span> Copied!';
        setTimeout(() => { btn.innerHTML = originalHtml; }, 2000);
        
        // Optional: Show Toast
        const toast = document.getElementById("toast");
        toast.innerText = "Wiki Markup copied to clipboard!";
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    },
    editProjectLink: (id, field) => {
        const item = store.get('projects', id);
        const currentVal = item[field] || '';
        
        // Use a prompt to allow editing the existing string
        const newVal = prompt(`Edit ${field} URL (clear to remove):`, currentVal);
        
        // If user didn't press Cancel (null)
        if (newVal !== null) {
            updateField('projects', id, field, newVal.trim());
        }
    },

    // ... existing functions
    openSystemStopModal: (projectId) => {
        const project = store.get('projects', projectId);
        document.getElementById('sysLogTitle').innerText = project.name;
        document.getElementById('sysLogInput').value = ''; // Clear previous
        document.getElementById('systemLogModal').showModal();
        
        // Focus the textarea
        setTimeout(() => document.getElementById('sysLogInput').focus(), 100);
    },

    confirmSystemStop: () => {
        const desc = document.getElementById('sysLogInput').value.trim();
        const finalDesc = desc || "Logged work (No description provided)";
        
        document.getElementById('systemLogModal').close();
        
        // Call the finalizer with the description
        finalizeStopTimer(true, finalDesc);
    },
	
	openCreateModal: (type, prefillName = null) => {
        const modal = document.getElementById('createModal');
        const inputsDiv = document.getElementById('modalInputs');
        const title = document.getElementById('modalTitle');
        const form = document.getElementById('modalForm');

        title.innerText = `New ${type.replace(/s$/, '').replace(/Link/, 'Link')}`; 
        if(type === 'quickLinks') title.innerText = 'New Quick Link';
        
        inputsDiv.innerHTML = '';
        currentModalKeywords = [];

        if (type === 'programs') {
            inputsDiv.innerHTML = `
                <div class="input-group"><label>Short Name</label><input name="shortName" required type="text"></div>
                <div class="input-group"><label>Long Name</label><input name="longName" required type="text"></div>
                <div class="input-group"><label>Short Description</label><textarea name="shortDescription"></textarea></div>
            `;
        } else if (type === 'tables') {
            inputsDiv.innerHTML = `
                <div class="input-group"><label>Name</label><input name="name" required type="text"></div>
                <div class="input-group"><label>Description</label><textarea name="description"></textarea></div>
            `;
        } else if (type === 'queries') {
            inputsDiv.innerHTML = `
                <div class="input-group"><label>Name</label><input name="name" required type="text"></div>
                <div class="input-group"><label>Update Indicator</label>
                    <select name="updateIndicator">
                        <option value="R">Read</option><option value="C">Create</option>
                        <option value="U">Update</option><option value="D">Delete</option>
                    </select>
                </div>
                <div class="input-group"><label>SQL/Query</label><textarea name="query"></textarea></div>
            `;
        } else if (type === 'projects') {
            inputsDiv.innerHTML = `
                <div class="input-group"><label>Name</label><input name="name" required type="text"></div>
                <div class="input-group"><label>Description</label><textarea name="description"></textarea></div>
                <div class="input-group"><label>Status</label>
                    <select name="status">
                        <option value="ANA">Analysis</option><option value="DEV">Development</option>
                        <option value="APB">Approval</option><option value="DONE">Done</option>
                    </select>
                </div>
            `;
        } else if (type === 'mailbox') {
            inputsDiv.innerHTML = `
                <div class="input-group"><label>Sender E-mail</label><input name="sender" required type="text" placeholder="user@example.com"></div>
                <div class="input-group"><label>Subject</label><input name="subject" required type="text"></div>
                <div class="input-group">
                    <label>Keywords</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="keywordIn" placeholder="Type and press Add (or Enter)..." onkeydown="if(event.key==='Enter'){event.preventDefault(); addModalKeyword();}">
                        <button type="button" class="btn btn-tonal" onclick="addModalKeyword()">Add</button>
                    </div>
                    <div id="keywordListDisplay" style="margin-top:8px; display:flex; gap:4px; flex-wrap:wrap;"></div>
                </div>
                <div class="input-group"><label>Status</label>
                    <div class="status-slider-container">
                        <div class="status-slider-label"><span>Open</span><span>Solved</span></div>
                        <input type="range" min="0" max="1" value="0" name="statusRange" class="status-slider">
                    </div>
                </div>
            `;
        } else if (type === 'quickLinks') {
            inputsDiv.innerHTML = `
                <div class="input-group"><label>Title</label><input name="title" required type="text" placeholder="e.g. GitHub"></div>
                <div class="input-group"><label>URL</label><input name="url" required type="text" placeholder="https://..."></div>
                <div class="input-group"><label>Icon (Emoji)</label><input name="icon" type="text" placeholder="e.g. üöÄ" maxlength="2"></div>
                <div class="input-group"><label>Description</label><input name="description" type="text" placeholder="Short description"></div>
            `;
        }
		if (prefillName) {
            // Try to find standard name input or shortName input (for programs)
            const nameInput = inputsDiv.querySelector('input[name="name"]') || inputsDiv.querySelector('input[name="shortName"]');
            if (nameInput) {
                nameInput.value = prefillName;
            }
        }

        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const obj = Object.fromEntries(formData.entries());

            // --- FEATURE ADDITION: UNIQUE NAME CHECK ---
            // Determine which field holds the "name" based on type
            let nameToCheck = null;
            if (type === 'programs') nameToCheck = obj.shortName;
            else if (type === 'mailbox') nameToCheck = obj.subject; // Optional: check mailbox subject uniqueness
            else if (type === 'quickLinks') nameToCheck = obj.title; 
            else nameToCheck = obj.name; // Tables, Queries, Projects

            // Check if it exists (Case-insensitive check provided by store.findByName)
            if (nameToCheck && (type === 'programs' || type === 'tables')) {
                const exists = store.findByName(type, nameToCheck);
                if (exists) {
                    alert(`Error: A ${type.slice(0, -1)} with the name "${nameToCheck}" already exists.\nPlease choose a unique name.`);
                    return; // Stop execution, do not close modal
                }
            }
            // -------------------------------------------

            if(type === 'programs') { obj.linkedTables = []; obj.linkedPrograms = []; }
            if(type === 'tables') { obj.fields = []; obj.links = []; } 
            if(type === 'projects') { obj.todos = []; obj.linkedTables = []; obj.linkedPrograms = []; }
            if(type === 'mailbox') { 
                obj.keywords = currentModalKeywords; 
                obj.status = obj.statusRange == "1" ? "Solved" : "Open";
                delete obj.statusRange;
                obj.workLog = [];
            }
            
            store.add(type, obj); // Handles saving
            modal.close();
            
            if (type === 'quickLinks') {
                router.renderList('dashboard'); // Refresh dashboard
            } else {
                router.navigate(type); // Navigate to list
            }
        };
        modal.showModal();
    },
    
    // Open Field Details
    openFieldModal: (tableId, fieldIdx) => {
        const item = store.get('tables', tableId);
        if(!item || !item.fields || !item.fields[fieldIdx]) return;
        const f = item.fields[fieldIdx];

        document.getElementById('fieldTableId').value = tableId;
        document.getElementById('fieldIndex').value = fieldIdx;
        document.getElementById('fieldName').value = f.name || '';
        document.getElementById('fieldDesc').value = f.desc || '';
        document.getElementById('fieldEx').value = f.ex || '';
        document.getElementById('fieldComm').value = f.comm || '';
        
        const modal = document.getElementById('fieldModal');
        const form = document.getElementById('fieldForm');
        
        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const updated = Object.fromEntries(formData.entries());
            
            // Update Store
            const currentTable = store.get('tables', updated.tableId);
            const fields = currentTable.fields;
            fields[updated.fieldIndex] = {
                name: updated.name,
                desc: updated.desc,
                ex: updated.ex,
                comm: updated.comm
            };
            store.update('tables', updated.tableId, { fields: fields });
            
            modal.close();
            router.renderDetail('tables', updated.tableId);
        };

        modal.showModal();
    },

    openLinkModal: (tableId, tableName) => {
        const modal = document.getElementById('linkModal');
        const form = document.getElementById('linkForm');
        document.getElementById('linkFromTableId').value = tableId;
        document.getElementById('linkFromTableName').value = tableName;
        
        // Reset inputs
        document.getElementById('linkToTableInput').value = '';
        form.querySelector('textarea').value = '';
        document.getElementById('linkBidirectional').checked = false;

        // Populate Table Suggestions (Excluding self)
        const dl = document.getElementById('tableSuggestions');
        dl.innerHTML = store.getAll('tables')
            .filter(t => t.id !== tableId)
            .map(t => `<option value="${t.name}">`)
            .join('');
		
        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const toTable = formData.get('toTable');
            const joinStmt = formData.get('joinStatement');
            const isBi = formData.get('bidirectional') === 'on';
            
            const item = store.get('tables', tableId);
            if (!item.links) item.links = [];
            
            item.links.push({
                toTable: toTable,
                join: joinStmt,
                bidirectional: isBi
            });
            
            store.update('tables', tableId, { links: item.links });
            modal.close();
            router.renderDetail('tables', tableId);
        };
        modal.showModal();
    },

    openAdjustModal: (projectId) => {
        adjustProjectId = projectId;
        document.getElementById('adjustTimeInput').value = '';
        document.getElementById('adjustTimeModal').showModal();
    },

    confirmAdjust: (mode) => {
        const inputVal = document.getElementById('adjustTimeInput').value.trim();
        if (!inputVal) return;

        let ms = 0;
        
        // Simple Parser: Check for colon vs number
        if (inputVal.includes(':')) {
            const parts = inputVal.split(':').reverse(); // sec, min, hour
            let seconds = 0;
            if (parts[0]) seconds += parseInt(parts[0]);
            if (parts[1]) seconds += parseInt(parts[1]) * 60;
            if (parts[2]) seconds += parseInt(parts[2]) * 3600;
            ms = seconds * 1000;
        } else {
            // Assume minutes
            const mins = parseFloat(inputVal);
            if (!isNaN(mins)) {
                ms = mins * 60 * 1000;
            }
        }

        if (isNaN(ms)) {
            alert('Invalid time format.');
            return;
        }

        const project = store.get('projects', adjustProjectId);
        let current = project.timeSpent || 0;

        if (mode === 'add') current += ms;
        if (mode === 'sub') current = Math.max(0, current - ms);
        if (mode === 'set') current = ms;

        store.update('projects', adjustProjectId, { timeSpent: current });
        document.getElementById('adjustTimeModal').close();
        
        // Refresh Current View
        if (router.currentView === 'projects') {
            router.renderDetail('projects', adjustProjectId);
        } else if (router.currentView === 'logwork') {
            renderLogWork();
        }
    },

    // --- QUICK LINK DELETE ---
    openDeleteConfirm: (id) => {
        pendingDeleteId = id;
        document.getElementById('deleteConfirmModal').showModal();
    },

    performDeleteQuickLink: () => {
        if (!pendingDeleteId) return;
        store.delete('quickLinks', pendingDeleteId);
        pendingDeleteId = null;
        document.getElementById('deleteConfirmModal').close();
        router.renderList('dashboard');
    },

    // --- REMINDERS ---
    openReminderModal: () => {
        document.getElementById('remText').value = '';
        document.getElementById('remDate').value = '';
        document.getElementById('remTime').value = '';
        document.getElementById('reminderModal').showModal();
    },

    saveReminder: () => {
        const text = document.getElementById('remText').value;
        const d = document.getElementById('remDate').value;
        const t = document.getElementById('remTime').value;

        if (!text || !d || !t) {
            alert("Please fill in all fields.");
            return;
        }

        const dt = new Date(`${d}T${t}`);
        
        store.add('reminders', {
            text: text,
            datetime: dt.toISOString(),
            dismissed: false
        });

        document.getElementById('reminderModal').close();
    },

    dismissCurrentReminder: () => {
        if (currentReminderId) {
            store.update('reminders', currentReminderId, { dismissed: true });
            currentReminderId = null;
        }
        document.getElementById('reminderAlertModal').close();
    }
};
/**
 * --- MERGE LOGIC HANDLERS (Add to UI object or global) ---
 */
ui.initMerge = function() {
    const inputStr = document.getElementById('mergeInput').value.trim();
    if (!inputStr) { alert("Please paste valid JSON data."); return; }

    let inputData;
    try {
        inputData = JSON.parse(inputStr);
    } catch (e) {
        alert("Invalid JSON format.");
        return;
    }

    // Prepare Summary
    const summaryList = document.getElementById('mergeSummary');
    summaryList.innerHTML = '';
    
    // Store data temporarily for the execution phase
    window.mergePayload = { data: inputData, config: {} };
    let hasSelection = false;

    ['programs', 'tables', 'queries', 'projects', 'mailbox'].forEach(type => {
        const doLoad = document.getElementById(`load_${type}`).checked;
        const doOver = document.getElementById(`over_${type}`).checked;
        
        window.mergePayload.config[type] = { load: doLoad, overwrite: doOver };

        if (doLoad && inputData[type] && inputData[type].length > 0) {
            hasSelection = true;
            const count = inputData[type].length;
            summaryList.innerHTML += `<li><strong>${type.toUpperCase()}</strong>: Found ${count} items. ${doOver ? '(Overwrite ON)' : '(Overwrite OFF)'}</li>`;
        }
    });

    if (!hasSelection) {
        alert("No data found for the selected types.");
        return;
    }

    // Check Backup
    window.mergePayload.backup = document.getElementById('backupFirst').checked;

    document.getElementById('mergeConfirmModal').showModal();
};
/* --- SMART LINK WIDGET LOGIC --- */
ui.renderLinkWidget = function(projectId, fieldKey, label, value) {
    // 1. If value exists, render CARD
    if (value) {
        return `
            <div class="link-card-display card-type-${fieldKey} link-input-anim" 
                 onclick="window.open('${value}', '_blank')" 
                 title="${value}">
                
                <div class="link-card-content">
                    <span class="link-card-label">${label}</span>
                    <span class="link-card-url">üîó ${value.replace(/^https?:\/\//, '')}</span>
                </div>
                
                <div class="link-card-actions">
                    <button class="btn btn-icon-only btn-tonal" 
                        onclick="event.stopPropagation(); ui.toggleLinkEdit('${projectId}', '${fieldKey}', '${label}')">
                        ‚úé
                    </button>
                </div>
            </div>
        `;
    } 
    
    // 2. If empty, render INPUT
    else {
        return `
            <div class="link-input-state link-input-anim">
                <label style="margin-left: 4px;">${label}</label>
                <input type="text" 
                    placeholder="Paste URL + Enter..." 
                    value="${value || ''}"
                    onkeydown="if(event.key === 'Enter') this.blur()"
                    onblur="ui.saveLinkWidget('${projectId}', '${fieldKey}', '${label}', this.value)"
                    autofocus
                >
            </div>
        `;
    }
};

ui.saveLinkWidget = function(projectId, fieldKey, label, newValue) {
    const val = newValue.trim();
    
    // 1. Update Data Store silently
    store.update('projects', projectId, { [fieldKey]: val });

    // 2. Update ONLY this specific wrapper in the DOM (No full reload)
    const wrapper = document.getElementById(`wrapper-${fieldKey}`);
    if (wrapper) {
        wrapper.innerHTML = ui.renderLinkWidget(projectId, fieldKey, label, val);
    }
};

ui.toggleLinkEdit = function(projectId, fieldKey, label) {
    // 1. Get current value from store
    const item = store.get('projects', projectId);
    const currentVal = item[fieldKey] || '';

    // 2. Force render the INPUT view into the wrapper
    const wrapper = document.getElementById(`wrapper-${fieldKey}`);
    if (wrapper) {
        // We temporarily pass 'null' as value to renderLinkWidget to force the Input view,
        // but we manually inject the value back into the input so the user doesn't lose it.
        wrapper.innerHTML = `
            <div class="link-input-state link-input-anim">
                <label style="margin-left: 4px;">${label}</label>
                <input type="text" 
                    id="edit-input-${fieldKey}"
                    value="${currentVal}"
                    placeholder="Paste URL..." 
                    onkeydown="if(event.key === 'Enter') this.blur()"
                    onblur="ui.saveLinkWidget('${projectId}', '${fieldKey}', '${label}', this.value)"
                >
            </div>
        `;
        // Auto-focus the input
        setTimeout(() => {
            const inp = document.getElementById(`edit-input-${fieldKey}`);
            if(inp) { inp.focus(); inp.select(); }
        }, 50);
    }
};
ui.executeMerge = function() {
    const payload = window.mergePayload;
    const backup = payload.backup;

    document.getElementById('mergeConfirmModal').close();

    // 1. Perform Backup if requested
    if (backup) {
        app.saveToFile(); // Triggers download
    }

    // 2. Process Merge
    const types = ['programs', 'tables', 'queries', 'projects', 'mailbox'];
    
    types.forEach(type => {
        const conf = payload.config[type];
        const incomingList = payload.data[type] || [];

        if (conf.load && incomingList.length > 0) {
            incomingList.forEach(item => {
                // Determine Name for matching
                const name = item.name || item.shortName || item.subject;
                if (!name) return; // Skip invalid items

                const existing = store.findByName(type, name);

                if (existing) {
                    if (conf.overwrite) {
                        // OVERWRITE STRATEGY: Update properties, preserve ID (to keep links safe)
                        const originalId = existing.id;
                        // Determine created date: keep original or use new? Usually keep original if overwrite.
                        const originalCreated = existing.createdAt; 
                        
                        // Merge object
                        const merged = { ...item, id: originalId, createdAt: originalCreated };
                        store.update(type, originalId, merged);
                    }
                    // If overwrite is FALSE, we do nothing (Skip)
                } else {
                    // NEW ITEM
                    // Ensure ID doesn't clash (rare but possible with raw JSON paste)
                    if (store.get(type, item.id)) {
                        item.id = store.generateId();
                    }
                    store.add(type, item);
                }
            });
        }
    });

    // 3. Play Animation
    const overlay = document.getElementById('successOverlay');
    overlay.style.display = 'flex';
    
    setTimeout(() => {
        overlay.style.display = 'none';
        // Refresh view
        router.navigate('dashboard');
    }, 2500);
};
const app = {
    saveToFile: () => {
        lastSaveTime = Date.now();
        updateStatusBar();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(store.data));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "dev_manager_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    },
    loadFromFile: (input) => {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => store.importData(e.target.result);
        reader.readAsText(file);
    },
    copyToClipboard: () => {
        lastSaveTime = Date.now();
        updateStatusBar();
        const dataStr = JSON.stringify(store.data, null, 2);
        
        // Use a temporary textarea to ensure compatibility
        const el = document.createElement('textarea');
        el.value = dataStr;
        el.setAttribute('readonly', '');
        el.style.position = 'absolute';
        el.style.left = '-9999px';
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);

        // Show toast
        const toast = document.getElementById("toast");
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    },
    toggleTheme: () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('mdoc_theme', newTheme);
        
        // Update button text/icon
        const btn = document.getElementById('themeToggleBtn');
        btn.innerText = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    },
    initTheme: () => {
        const stored = localStorage.getItem('mdoc_theme');
        if(stored) {
            document.documentElement.setAttribute('data-theme', stored);
            document.getElementById('themeToggleBtn').innerText = stored === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
    }
};
/* =========================================
   FEATURE: OMNI SEARCH (COMMAND PALETTE)
   ========================================= */
document.addEventListener('keydown', (e) => {
    // Shortcut: Ctrl+K or Cmd+K
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        ui.openOmniSearch();
    }
    // Shortcut: Esc to close
    if (e.key === 'Escape') {
        ui.closeOmniSearch();
    }
});

ui.openOmniSearch = function() {
    const modal = document.getElementById('omniSearchModal');
    modal.style.display = 'flex';
    const input = document.getElementById('omniInput');
    input.value = '';
    input.focus();
    ui.runOmniSearch(''); // Show recent or empty state
    
    // Bind Input Logic
    input.oninput = (e) => ui.runOmniSearch(e.target.value);
    
    // Bind Keyboard Navigation
    input.onkeydown = (e) => {
        const list = document.getElementById('omniResults');
        const items = list.querySelectorAll('.omni-item');
        let activeIdx = Array.from(items).findIndex(el => el.classList.contains('selected'));
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (activeIdx < items.length - 1) {
                if(activeIdx > -1) items[activeIdx].classList.remove('selected');
                items[activeIdx + 1].classList.add('selected');
                items[activeIdx + 1].scrollIntoView({block: 'nearest'});
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (activeIdx > 0) {
                items[activeIdx].classList.remove('selected');
                items[activeIdx - 1].classList.add('selected');
                items[activeIdx - 1].scrollIntoView({block: 'nearest'});
            }
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIdx > -1) items[activeIdx].click();
            else if (items.length > 0) items[0].click(); // Select first if none selected
        }
    };
};

ui.closeOmniSearch = function() {
    document.getElementById('omniSearchModal').style.display = 'none';
};

ui.runOmniSearch = function(query) {
    const q = query.toLowerCase();
    const results = document.getElementById('omniResults');
    results.innerHTML = '';
    
    const map = { 
        'programs': { lbl: 'PROG', w: 10 }, 
        'tables': { lbl: 'TAB', w: 8 }, 
        'queries': { lbl: 'QRY', w: 5 }, 
        'projects': { lbl: 'PROJ', w: 8 },
        'mailbox': { lbl: 'MAIL', w: 5 }
    };

    let allItems = [];

    // Aggregate all searchable items
    Object.keys(map).forEach(type => {
        store.getAll(type).forEach(item => {
            const name = item.name || item.shortName || item.subject || '';
            const desc = item.description || item.shortDescription || '';
            
            // Simple scoring algorithm
            let score = 0;
            if (q === '') score = 1; // Show all if empty (could limit to recent)
            else {
                if (name.toLowerCase() === q) score += 20; // Exact match
                else if (name.toLowerCase().startsWith(q)) score += 10;
                else if (name.toLowerCase().includes(q)) score += 5;
                
                if (desc.toLowerCase().includes(q)) score += 1;
            }
            
            // Apply weight based on type
            score += map[type].w;

            if (score > 0) {
                allItems.push({ 
                    ...item, 
                    type, 
                    typeLabel: map[type].lbl, 
                    score,
                    // Store display name for rendering
                    displayName: name,
                    displayDesc: desc
                });
            }
        });
    });

    // Sort by Score DESC
    allItems.sort((a,b) => b.score - a.score);

    if (allItems.length === 0) {
        results.innerHTML = '<div style="padding:20px; text-align:center; opacity:0.5">No matching results found.</div>';
        return;
    }

    // Render Limit 15
    allItems.slice(0, 15).forEach((item, idx) => {
        const div = document.createElement('div');
        div.className = `omni-item ${idx === 0 ? 'selected' : ''}`; // Auto-select first
        div.innerHTML = `
            <span class="omni-type ${item.typeLabel}">${item.typeLabel}</span>
            <div style="overflow:hidden;">
                <div style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.displayName}</div>
                <div style="font-size:0.8rem; opacity:0.7; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.displayDesc}</div>
            </div>
        `;
        div.onclick = () => {
            ui.closeOmniSearch();
            router.navigate(item.type, item.id);
        };
        results.appendChild(div);
    });
};

/* =========================================
   FEATURE: CANVAS ERD VISUALIZER
   ========================================= */
function renderERDView() {
    const mainEl = document.getElementById('mainContent');
    mainEl.innerHTML = `
        <div class="header-row">
            <h1 class="page-title">Schema Visualizer</h1>
            <div>
                <button class="btn btn-outlined" onclick="initERD()">‚Üª Reset View</button>
            </div>
        </div>
        <p style="margin-bottom:1rem; opacity:0.7;">Visual representation of Tables and their bidirectional links.</p>
        
        <div class="erd-container">
            <canvas id="erdCanvas"></canvas>
            <div style="position:absolute; bottom:15px; right:15px; background:var(--md-sys-color-surface); 
                        padding:6px 12px; border-radius:6px; font-size:0.8rem; box-shadow:var(--md-sys-elevation-1); border:1px solid var(--md-sys-color-outline-variant);">
                üñ±Ô∏è Drag to Pan ‚Ä¢ üìú Scroll to Zoom
            </div>
        </div>
    `;
    // Delay init to allow DOM painting
    setTimeout(initERD, 50);
}

function initERD() {
    const canvas = document.getElementById('erdCanvas');
    if(!canvas) return;
    const container = canvas.parentElement;
    const ctx = canvas.getContext('2d');
    
    // Set resolution
    canvas.width = container.clientWidth;
    canvas.height = container.clientHeight;

    // State
    const tables = store.getAll('tables');
    let offsetX = canvas.width / 2 - 100; // Center ish
    let offsetY = 50;
    let scale = 1;
    let isDragging = false, lastX, lastY;

    // Node Calculation
    const cardW = 200;
    const headerH = 35;
    const rowH = 20;
    const nodes = [];

    // Simple Grid Auto-Layout
    const cols = Math.ceil(Math.sqrt(tables.length + 1)); 
    tables.forEach((t, i) => {
        const c = i % cols;
        const r = Math.floor(i / cols);
        const contentH = (t.fields || []).length * rowH;
        
        nodes.push({
            id: t.id,
            name: t.name,
            x: c * (cardW + 100),
            y: r * 300,
            w: cardW,
            h: headerH + contentH + 10,
            fields: t.fields || [],
            links: t.links || []
        });
    });

    function draw() {
        // Clear
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Transform
        ctx.translate(offsetX, offsetY);
        ctx.scale(scale, scale);

        // 1. Draw Links (Bezier Curves)
        ctx.lineWidth = 2;
        nodes.forEach(node => {
            if(!node.links) return;
            node.links.forEach(link => {
                const target = nodes.find(n => n.name === link.toTable);
                if(target) {
                    const sx = node.x + node.w; 
                    const sy = node.y + headerH / 2;
                    const ex = target.x;
                    const ey = target.y + headerH / 2;

                    // Gradient Stroke
                    const grad = ctx.createLinearGradient(sx, sy, ex, ey);
                    grad.addColorStop(0, '#94a3b8');
                    grad.addColorStop(1, '#64748b');
                    ctx.strokeStyle = grad;

                    ctx.beginPath();
                    ctx.moveTo(sx, sy);
                    ctx.bezierCurveTo(sx + 80, sy, ex - 80, ey, ex, ey);
                    ctx.stroke();
                    
                    // Arrowhead
                    ctx.fillStyle = '#64748b';
                    ctx.beginPath();
                    ctx.arc(ex, ey, 4, 0, Math.PI*2);
                    ctx.fill();
                }
            });
        });

        // 2. Draw Nodes
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        
        nodes.forEach(node => {
            // Shadow
            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetY = 5;

            // Card Bg
            ctx.fillStyle = isDark ? '#1e293b' : '#ffffff';
            ctx.fillRect(node.x, node.y, node.w, node.h);
            ctx.shadowBlur = 0; // reset

            // Border
            ctx.strokeStyle = isDark ? '#334155' : '#cbd5e1';
            ctx.lineWidth = 1;
            ctx.strokeRect(node.x, node.y, node.w, node.h);

            // Header
            ctx.fillStyle = isDark ? '#334155' : '#f1f5f9';
            ctx.fillRect(node.x, node.y, node.w, headerH);
            
            // Header Text
            ctx.fillStyle = isDark ? '#f8fafc' : '#0f172a';
            ctx.font = 'bold 13px sans-serif';
            ctx.fillText(node.name, node.x + 10, node.y + 22);
            
            // Fields
            ctx.font = '11px monospace';
            ctx.fillStyle = isDark ? '#94a3b8' : '#475569';
            node.fields.forEach((f, idx) => {
                const fy = node.y + headerH + 16 + (idx * rowH);
                ctx.fillText(f.name, node.x + 10, fy);
                // Type hint (fake)
                ctx.fillStyle = isDark ? '#475569' : '#cbd5e1';
                ctx.fillText('VARCHAR', node.x + node.w - 55, fy);
                ctx.fillStyle = isDark ? '#94a3b8' : '#475569'; // restore
            });
        });

        ctx.restore();
    }

    // Input Handlers
    canvas.onmousedown = (e) => { isDragging = true; lastX = e.clientX; lastY = e.clientY; };
    window.onmouseup = () => { isDragging = false; };
    canvas.onmousemove = (e) => {
        if(isDragging) {
            offsetX += e.clientX - lastX;
            offsetY += e.clientY - lastY;
            lastX = e.clientX;
            lastY = e.clientY;
            requestAnimationFrame(draw);
        }
    };
    canvas.onwheel = (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        scale = Math.min(Math.max(0.2, scale * delta), 3);
        requestAnimationFrame(draw);
    };

    draw();
}

/* =========================================
   FEATURE: TAB SUPPORT FOR TEXTAREAS
   ========================================= */
// Automatically apply to all textareas on focus
document.addEventListener('focusin', function(e) {
    if(e.target.tagName === 'TEXTAREA') {
        e.target.onkeydown = function(ev) {
            if(ev.key === 'Tab') {
                ev.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                // Insert 2 spaces
                this.value = this.value.substring(0, start) + "  " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 2;
            }
        };
    }
});
// Initialize
app.initTheme();
const router = new Router();
router.navigate('dashboard');

</script>
</body>
</html>
