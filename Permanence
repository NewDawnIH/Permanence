<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permanence Planner - Offline Version</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --am-bg: #dbeafe;
            --am-text: #1d4ed8;
            --pm-bg: #f3e8ff;
            --pm-text: #7e22ce;
            --danger: #ef4444;
            --success: #16a34a;
            --highlight: #e0f2fe; /* Light blue for highlighting */
            --highlight-border: #7dd3fc;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text-main); line-height: 1.5; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }
       
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .tabs { background: #fff; padding: 4px; border-radius: 12px; border: 1px solid var(--border); display: flex; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .tab-btn { padding: 8px 16px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 600; color: var(--text-muted); font-size: 14px; transition: all 0.2s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .card { background: white; border-radius: 16px; border: 1px solid var(--border); padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; transition: border-color 0.3s, box-shadow 0.3s; }
        .card.active-panel { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
       
        h2 { font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
       
        .grid-layout { display: grid; grid-template-columns: 280px 1fr; gap: 24px; }
        @media (max-width: 768px) { .grid-layout { grid-template-columns: 1fr; } }

        select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: #fcfcfc; font-size: 14px; outline: none; margin-bottom: 12px; }
        textarea { font-family: monospace; height: 120px; resize: none; }
       
        .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-dark { background: #1e293b; color: white; }

        .instructions { font-size: 13px; color: var(--text-muted); margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px; }
        .instructions ul { padding-left: 18px; margin-top: 8px; }
        .instructions li { margin-bottom: 8px; }

        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .cal-header { font-size: 11px; font-weight: 800; color: #cbd5e1; text-transform: uppercase; padding-bottom: 8px; }
        .day { height: 90px; border: 1px solid #f1f5f9; border-radius: 8px; position: relative; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; transition: 0.1s; background: white; }
        .day:hover { background: #f8fafc; }
        .day-num { font-size: 12px; font-weight: 700; color: #94a3b8; margin-bottom: 4px; }
        .day.empty { cursor: default; background: transparent; border: none; }
        .day.weekend { background: #f1f5f9; opacity: 0.5; cursor: not-allowed; }
        .day.missing { background: #fef2f2; border-color: #fecaca; }
       
        /* Highlighting style */
        .day.highlighted { background: var(--highlight) !important; border: 1px solid var(--highlight-border); }

        .tag { font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tag-am { background: var(--am-bg); color: var(--am-text); }
        .tag-pm { background: var(--pm-bg); color: var(--pm-text); }
        .tag-empty { background: #fff; color: var(--danger); border: 1px solid #fee2e2; }

        .chart-container { height: 200px; display: flex; align-items: flex-end; justify-content: space-around; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-top: 20px; }
        .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; height: 100%; cursor: pointer; }
        .bar-group:hover .bar { opacity: 0.8; }
        .bar-group.active-filter .bar-vol { outline: 2px solid var(--primary); outline-offset: 2px; }
       
        .bars { display: flex; gap: 4px; align-items: flex-end; height: 100%; width: 100%; justify-content: center; }
        .bar { width: 14px; border-radius: 3px 3px 0 0; min-height: 2px; transition: height 0.3s ease; }
        .bar-vol { background: #e0e7ff; }
        .bar-ass { background: var(--primary); }
        .bar-label { font-size: 10px; font-weight: 700; color: var(--text-muted); margin-top: 30px; transform: rotate(45deg); transform-origin: left; white-space: nowrap; }

        .hidden { display: none !important; }
        .feedback { color: var(--success); font-size: 13px; font-weight: 600; margin-top: 10px; display: flex; align-items: center; gap: 4px; opacity: 1; transition: opacity 0.5s; }
       
        .roster-section { margin-top: 40px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1 id="title-month">Permanence Planner</h1>
            <p style="color:var(--text-muted)" id="title-year">Loading...</p>
        </div>
        <div class="tabs">
            <button class="tab-btn active" id="tab-btn-select" onclick="switchTab('select')">My Availability</button>
            <button class="tab-btn" id="tab-btn-coordinate" onclick="switchTab('coordinate')">Schedule Builder</button>
        </div>
    </header>

    <!-- TAB 1: SELECTION -->
    <div id="tab-select" class="grid-layout">
        <div class="sidebar">
            <div class="card active-panel" id="panel-identify">
                <h2>Identify</h2>
                <select id="user-select" onchange="updateUser()">
                    <option value="">Who are you?</option>
                </select>
                <div id="user-actions" class="hidden">
                    <button class="btn btn-primary" onclick="copyData()">Copy Data String</button>
                    <div id="copy-feedback" class="feedback hidden">✓ Copied to clipboard!</div>
                </div>

                <div class="instructions">
                    <strong>How to use:</strong>
                    <ul>
                        <li>Click on the days to select a shift. Click again to switch between Early (AM) or Late (PM) shift.</li>
                        <li>When you are ready, click <strong>"Copy Data String"</strong>.</li>
                        <li>Paste that string into the <strong>Confluence page</strong> comments or table.</li>
                        <li>Once everyone has submitted, a coordinator can import all strings in the "Schedule Builder" tab.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="calendar" id="selection-calendar"></div>
        </div>
    </div>

    <!-- TAB 2: COORDINATION (Schedule Builder) -->
    <div id="tab-coordinate" class="hidden">
        <div class="grid-layout">
            <div class="sidebar">
                <div class="card active-panel" id="panel-import">
                    <h2>Import Data</h2>
                    <textarea id="import-area" placeholder="Paste data strings here..."></textarea>
                    <button class="btn btn-primary" onclick="importData()">Import Data</button>
                    <div id="import-feedback" class="feedback hidden">✓ Successfully imported!</div>
                </div>
                <div class="card" id="panel-generate">
                    <button class="btn btn-dark" onclick="generateRoster()">Generate Monthly Roster</button>
                </div>
            </div>
            <div class="card" id="analytics-card">
                <h2>Shift Distribution</h2>
                <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 10px;">Click a bar to highlight that person's volunteered days on the calendar below.</p>
                <div class="chart-container" id="chart-bars"></div>
                <div style="display:flex; justify-content:center; gap: 20px; margin-top: 50px; font-size: 10px; font-weight: bold; color: #94a3b8;">
                    <span><span style="display:inline-block; width:10px; height:10px; background:#e0e7ff; border-radius:2px;"></span> VOLUNTEERED</span>
                    <span><span style="display:inline-block; width:10px; height:10px; background:var(--primary); border-radius:2px;"></span> ASSIGNED</span>
                </div>
            </div>
        </div>
        <div class="card roster-section" id="roster-card">
            <h2>Final Schedule</h2>
            <div class="calendar" id="roster-calendar"></div>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    const EMPLOYEES = ["Alice Dupont", "Bob Martin", "Charlie Smith", "Diana Prince", "Edward Norton", "Fiona Gallagher"];
    const SHIFT_TYPES = { NONE: 'none', EARLY: 'early', LATE: 'late' };
    let currentUser = "";
    let allSubmissions = {};
    let finalSchedule = {};
    let highlightedEmployee = null; // Track who is currently selected in the chart
   
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();

    // --- INIT ---
    function init() {
        const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(today);
        document.getElementById('title-month').innerText = monthName + " Planner";
        document.getElementById('title-year').innerText = "Team Scheduling for " + currentYear;

        const select = document.getElementById('user-select');
        EMPLOYEES.forEach(e => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = e;
            select.appendChild(opt);
        });

        renderSelectionCalendar();
    }

    // --- TAB SYSTEM ---
    function switchTab(tab) {
        // Toggle tab button classes
        document.getElementById('tab-btn-select').classList.toggle('active', tab === 'select');
        document.getElementById('tab-btn-coordinate').classList.toggle('active', tab === 'coordinate');
       
        // Toggle tab visibility
        document.getElementById('tab-select').classList.toggle('hidden', tab !== 'select');
        document.getElementById('tab-coordinate').classList.toggle('hidden', tab !== 'coordinate');
       
        if (tab === 'coordinate') {
            setTimeout(renderAnalytics, 10);
        }
    }

    // --- LOGIC ---
    function updateUser() {
        currentUser = document.getElementById('user-select').value;
        document.getElementById('user-actions').classList.toggle('hidden', !currentUser);
        renderSelectionCalendar();
    }

    function toggleShift(day) {
        if (!currentUser) return;
        const dateKey = `${currentYear}-${currentMonth}-${day}`;
        if (!allSubmissions[currentUser]) allSubmissions[currentUser] = { name: currentUser, prefs: {} };
       
        const current = allSubmissions[currentUser].prefs[dateKey] || SHIFT_TYPES.NONE;
        let next = SHIFT_TYPES.EARLY;
        if (current === SHIFT_TYPES.EARLY) next = SHIFT_TYPES.LATE;
        else if (current === SHIFT_TYPES.LATE) next = SHIFT_TYPES.NONE;
       
        allSubmissions[currentUser].prefs[dateKey] = next;
        renderSelectionCalendar();
    }

    function copyData() {
        if (!currentUser || !allSubmissions[currentUser]) return;
        const str = btoa(JSON.stringify(allSubmissions[currentUser]));
       
        const textArea = document.createElement("textarea");
        textArea.value = str;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                const feedback = document.getElementById('copy-feedback');
                feedback.classList.remove('hidden');
                setTimeout(() => feedback.classList.add('hidden'), 2500);
            }
        } catch (err) {
            console.error('Fallback copy failed', err);
        }

        document.body.removeChild(textArea);
    }

    function importData() {
        const text = document.getElementById('import-area').value;
        const lines = text.split('\n').filter(l => l.trim());
        let count = 0;
        lines.forEach(l => {
            try {
                const data = JSON.parse(atob(l.trim()));
                if (data.name && data.prefs) {
                    allSubmissions[data.name] = data;
                    count++;
                }
            } catch(e) {}
        });
        document.getElementById('import-area').value = "";
       
        if (count > 0) {
            const feedback = document.getElementById('import-feedback');
            feedback.innerText = `✓ Imported ${count} colleagues!`;
            feedback.classList.remove('hidden');
            setTimeout(() => feedback.classList.add('hidden'), 3000);
           
            // Visual feedback: Move highlight to the Generate button panel
            document.getElementById('panel-import').classList.remove('active-panel');
            document.getElementById('panel-generate').classList.add('active-panel');
           
            renderAnalytics();
        }
    }

    function generateRoster() {
        finalSchedule = {};
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const counts = {};
        EMPLOYEES.forEach(e => counts[e] = 0);

        for (let d = 1; d <= daysInMonth; d++) {
            const date = new Date(currentYear, currentMonth, d);
            if (date.getDay() === 0 || date.getDay() === 6) continue;
            const dateKey = `${currentYear}-${currentMonth}-${d}`;

            [SHIFT_TYPES.EARLY, SHIFT_TYPES.LATE].forEach(type => {
                const volunteers = EMPLOYEES.filter(e => allSubmissions[e]?.prefs?.[dateKey] === type);
                if (volunteers.length > 0) {
                    volunteers.sort((a, b) => counts[a] - counts[b]);
                    const chosen = volunteers[0];
                    finalSchedule[`${dateKey}-${type}`] = chosen;
                    counts[chosen]++;
                } else {
                    finalSchedule[`${dateKey}-${type}`] = "UNASSIGNED";
                }
            });
        }
        renderRoster();
        renderAnalytics();
    }

    function toggleHighlight(name) {
        if (highlightedEmployee === name) {
            highlightedEmployee = null; // Clear if clicked again
        } else {
            highlightedEmployee = name; // Set new highlight
        }
        renderRoster();
        renderAnalytics();
    }

    // --- RENDERING ---
    function renderSelectionCalendar() {
        const cal = document.getElementById('selection-calendar');
        cal.innerHTML = "";
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(d => cal.innerHTML += `<div class="cal-header">${d}</div>`);

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) cal.innerHTML += `<div class="day empty"></div>`;
       
        for (let d = 1; d <= totalDays; d++) {
            const date = new Date(currentYear, currentMonth, d);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const status = (allSubmissions[currentUser]?.prefs[`${currentYear}-${currentMonth}-${d}`]) || 'none';
           
            let html = `<div class="day ${isWeekend ? 'weekend' : ''}" onclick="${isWeekend ? '' : 'toggleShift(' + d + ')'}">
                <span class="day-num">${d}</span>`;
            if (status !== 'none') {
                html += `<span class="tag ${status === 'early' ? 'tag-am' : 'tag-pm'}">${status === 'early' ? 'AM' : 'PM'}</span>`;
            }
            html += `</div>`;
            cal.innerHTML += html;
        }
    }

    function renderRoster() {
        const cal = document.getElementById('roster-calendar');
        cal.innerHTML = "";
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        days.forEach(d => cal.innerHTML += `<div class="cal-header">${d}</div>`);

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) cal.innerHTML += `<div class="day empty"></div>`;

        for (let d = 1; d <= totalDays; d++) {
            const date = new Date(currentYear, currentMonth, d);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const dateKey = `${currentYear}-${currentMonth}-${d}`;
           
            if (isWeekend) {
                cal.innerHTML += `<div class="day weekend"><span class="day-num">${d}</span></div>`;
                continue;
            }

            const am = finalSchedule[`${dateKey}-${SHIFT_TYPES.EARLY}`];
            const pm = finalSchedule[`${dateKey}-${SHIFT_TYPES.LATE}`];
            const missing = am === "UNASSIGNED" || pm === "UNASSIGNED";
           
            // Check if this day should be highlighted for the selected employee
            const isHighlighted = highlightedEmployee &&
                                 allSubmissions[highlightedEmployee]?.prefs?.[dateKey] &&
                                 allSubmissions[highlightedEmployee]?.prefs?.[dateKey] !== 'none';

            let html = `<div class="day ${missing ? 'missing' : ''} ${isHighlighted ? 'highlighted' : ''}">
                <span class="day-num">${d}</span>`;
            html += `<span class="tag ${am === 'UNASSIGNED' ? 'tag-empty' : 'tag-am'}">AM: ${am === 'UNASSIGNED' ? 'EMPTY' : am.split(' ')[0]}</span>`;
            html += `<span class="tag ${pm === 'UNASSIGNED' ? 'tag-empty' : 'tag-pm'}">PM: ${pm === 'UNASSIGNED' ? 'EMPTY' : pm.split(' ')[0]}</span>`;
            html += `</div>`;
            cal.innerHTML += html;
        }
    }

    function renderAnalytics() {
        const container = document.getElementById('chart-bars');
        if (!container) return;
        container.innerHTML = "";
       
        const data = EMPLOYEES.map(name => {
            const vol = Object.values(allSubmissions[name]?.prefs || {}).filter(v => v !== 'none').length;
            const ass = Object.values(finalSchedule).filter(v => v === name).length;
            return { name, vol, ass };
        });

        let maxVal = 0;
        data.forEach(d => {
            if (d.vol > maxVal) maxVal = d.vol;
            if (d.ass > maxVal) maxVal = d.ass;
        });
        if (maxVal === 0) maxVal = 1;

        data.forEach(d => {
            const volPct = (d.vol / maxVal) * 100;
            const assPct = (d.ass / maxVal) * 100;
            const isActive = highlightedEmployee === d.name;
           
            const group = document.createElement('div');
            group.className = `bar-group ${isActive ? 'active-filter' : ''}`;
            group.onclick = () => toggleHighlight(d.name);
            group.innerHTML = `
                <div class="bars">
                    <div class="bar bar-vol" style="height: ${volPct}%" title="Volunteered: ${d.vol}"></div>
                    <div class="bar bar-ass" style="height: ${assPct}%" title="Assigned: ${d.ass}"></div>
                </div>
                <span class="bar-label" style="${isActive ? 'color: var(--primary); font-weight: 800;' : ''}">${d.name.split(' ')[0]}</span>
            `;
            container.appendChild(group);
        });
    }

    init();
</script>
</body>
</html>
