<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permanence Planner</title>
</head>
<body style="background-color: #f8fafc; color: #1e293b; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 20px; margin: 0;">

<div id="planner-app" style="max-width: 1100px; margin: 0 auto;">
    
    <!-- HEADER -->
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;">
        <div>
            <h1 id="title-month" style="font-size: 24px; margin: 0; color: #1e293b;">Permanence Planner</h1>
            <p id="title-year" style="color: #64748b; margin: 5px 0 0 0; font-size: 14px;">Team Scheduling</p>
        </div>
        <div style="background: #ffffff; padding: 4px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
            <button id="tab-btn-select" onclick="switchTab('select')" style="padding: 8px 16px; border: none; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 14px; transition: 0.2s; background: #4f46e5; color: #ffffff;">My Availability</button>
            <button id="tab-btn-coordinate" onclick="switchTab('coordinate')" style="padding: 8px 16px; border: none; cursor: pointer; border-radius: 8px; font-weight: 600; font-size: 14px; transition: 0.2s; background: transparent; color: #64748b;">Schedule Builder</button>
        </div>
    </header>

    <!-- TAB 1: SELECTION -->
    <div id="tab-select" style="display: block;">
        <div style="display: flex; flex-wrap: wrap; gap: 24px;">
            <!-- SIDEBAR -->
            <div style="flex: 1; min-width: 280px; max-width: 320px;">
                <div id="panel-identify" style="background: white; border-radius: 16px; border: 2px solid #4f46e5; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <h2 style="font-size: 18px; margin: 0 0 16px 0; color: #1e293b;">Identify</h2>
                    <select id="user-select" onchange="updateUser()" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fcfcfc; font-size: 14px; outline: none; margin-bottom: 12px;">
                        <option value="">Who are you?</option>
                    </select>
                    <div id="user-actions" style="display: none;">
                        <button onclick="copyData()" style="width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; background: #4f46e5; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px;">Copy Data String</button>
                        <div id="copy-feedback" style="display: none; color: #16a34a; font-size: 13px; font-weight: 600; margin-top: 10px; text-align: center;">✓ Copied to clipboard!</div>
                    </div>

                    <div style="font-size: 13px; color: #64748b; margin-top: 16px; border-top: 1px solid #e2e8f0; padding-top: 16px;">
                        <strong style="color: #1e293b;">How to use:</strong>
                        <ul style="padding-left: 18px; margin: 8px 0 0 0;">
                            <li style="margin-bottom: 8px;">Click days to toggle: AM (Blue), PM (Purple), or None.</li>
                            <li style="margin-bottom: 8px;">Click <strong>Copy Data String</strong> when finished.</li>
                            <li>Paste the string into Confluence comments.</li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- CALENDAR -->
            <div style="flex: 2; min-width: 350px; background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div id="selection-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;"></div>
            </div>
        </div>
    </div>

    <!-- TAB 2: COORDINATION -->
    <div id="tab-coordinate" style="display: none;">
        <div style="display: flex; flex-wrap: wrap; gap: 24px;">
            <div style="flex: 1; min-width: 280px; max-width: 320px;">
                <div id="panel-import" style="background: white; border-radius: 16px; border: 2px solid #4f46e5; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <h2 style="font-size: 18px; margin: 0 0 16px 0;">Import Data</h2>
                    <textarea id="import-area" placeholder="Paste strings here..." style="width: 100%; height: 100px; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; font-family: monospace; font-size: 12px; margin-bottom: 12px; resize: none;"></textarea>
                    <button onclick="importData()" style="width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; background: #4f46e5; color: white; font-size: 14px;">Import All Strings</button>
                    <div id="import-feedback" style="display: none; color: #16a34a; font-size: 13px; font-weight: 600; margin-top: 10px; text-align: center;">✓ Data imported!</div>
                </div>
                <div id="panel-generate" style="background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 24px;">
                    <button onclick="generateRoster()" style="width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; background: #1e293b; color: white; font-size: 14px;">Generate Roster</button>
                </div>
            </div>
            <div style="flex: 2; min-width: 350px; background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 24px;">
                <h2 style="font-size: 18px; margin: 0 0 10px 0;">Shift Distribution</h2>
                <p style="font-size: 11px; color: #64748b; margin-bottom: 15px;">Click a bar to highlight that person's availability below.</p>
                <div id="chart-bars" style="height: 180px; display: flex; align-items: flex-end; justify-content: space-around; gap: 10px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;"></div>
                <div style="display:flex; justify-content:center; gap: 20px; margin-top: 40px; font-size: 10px; font-weight: bold; color: #94a3b8;">
                    <span><span style="display:inline-block; width:8px; height:8px; background:#e0e7ff; border-radius:2px;"></span> VOLUNTEERED</span>
                    <span><span style="display:inline-block; width:8px; height:8px; background:#4f46e5; border-radius:2px;"></span> ASSIGNED</span>
                </div>
            </div>
        </div>
        
        <div style="background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 24px; margin-top: 40px;">
            <h2 style="font-size: 18px; margin: 0 0 16px 0;">Final Schedule</h2>
            <div id="roster-calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center;"></div>
        </div>
    </div>
</div>

<script>
    const EMPLOYEES = ["Alice Dupont", "Bob Martin", "Charlie Smith", "Diana Prince", "Edward Norton", "Fiona Gallagher"];
    const SHIFT_TYPES = { NONE: 'none', EARLY: 'early', LATE: 'late' };
    let currentUser = "";
    let allSubmissions = {}; 
    let finalSchedule = {};
    let highlightedEmployee = null;
    
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth();

    function init() {
        const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(today);
        document.getElementById('title-month').innerText = monthName + " Planner";
        document.getElementById('title-year').innerText = "Team Scheduling for " + currentYear;

        const select = document.getElementById('user-select');
        EMPLOYEES.forEach(e => {
            const opt = document.createElement('option');
            opt.value = opt.innerText = e;
            select.appendChild(opt);
        });

        renderSelectionCalendar();
    }

    function switchTab(tab) {
        const isSelect = tab === 'select';
        document.getElementById('tab-select').style.display = isSelect ? 'block' : 'none';
        document.getElementById('tab-coordinate').style.display = isSelect ? 'none' : 'block';
        
        const btnS = document.getElementById('tab-btn-select');
        const btnC = document.getElementById('tab-btn-coordinate');
        
        if(isSelect) {
            btnS.style.background = "#4f46e5"; btnS.style.color = "#ffffff";
            btnC.style.background = "transparent"; btnC.style.color = "#64748b";
        } else {
            btnC.style.background = "#4f46e5"; btnC.style.color = "#ffffff";
            btnS.style.background = "transparent"; btnS.style.color = "#64748b";
            setTimeout(renderAnalytics, 50);
        }
    }

    function updateUser() {
        currentUser = document.getElementById('user-select').value;
        document.getElementById('user-actions').style.display = currentUser ? 'block' : 'none';
        renderSelectionCalendar();
    }

    function toggleShift(day) {
        if (!currentUser) return;
        const dateKey = `${currentYear}-${currentMonth}-${day}`;
        if (!allSubmissions[currentUser]) allSubmissions[currentUser] = { name: currentUser, prefs: {} };
        const current = allSubmissions[currentUser].prefs[dateKey] || SHIFT_TYPES.NONE;
        let next = SHIFT_TYPES.EARLY;
        if (current === SHIFT_TYPES.EARLY) next = SHIFT_TYPES.LATE;
        else if (current === SHIFT_TYPES.LATE) next = SHIFT_TYPES.NONE;
        allSubmissions[currentUser].prefs[dateKey] = next;
        renderSelectionCalendar();
    }

    function copyData() {
        const str = btoa(JSON.stringify(allSubmissions[currentUser] || {name: currentUser, prefs: {}}));
        const textArea = document.createElement("textarea");
        textArea.value = str;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        const fb = document.getElementById('copy-feedback');
        fb.style.display = 'block';
        setTimeout(() => fb.style.display = 'none', 2000);
    }

    function importData() {
        const text = document.getElementById('import-area').value;
        const lines = text.split('\n').filter(l => l.trim());
        let count = 0;
        lines.forEach(l => {
            try {
                const data = JSON.parse(atob(l.trim()));
                if (data.name && data.prefs) { allSubmissions[data.name] = data; count++; }
            } catch(e) {}
        });
        if (count > 0) {
            const fb = document.getElementById('import-feedback');
            fb.innerText = `✓ ${count} users imported!`;
            fb.style.display = 'block';
            setTimeout(() => fb.style.display = 'none', 3000);
            renderAnalytics();
        }
        document.getElementById('import-area').value = "";
    }

    function generateRoster() {
        finalSchedule = {};
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const counts = {};
        EMPLOYEES.forEach(e => counts[e] = 0);
        for (let d = 1; d <= daysInMonth; d++) {
            const date = new Date(currentYear, currentMonth, d);
            if (date.getDay() === 0 || date.getDay() === 6) continue;
            const dateKey = `${currentYear}-${currentMonth}-${d}`;
            [SHIFT_TYPES.EARLY, SHIFT_TYPES.LATE].forEach(type => {
                const volunteers = EMPLOYEES.filter(e => allSubmissions[e]?.prefs?.[dateKey] === type);
                if (volunteers.length > 0) {
                    volunteers.sort((a, b) => counts[a] - counts[b]);
                    const chosen = volunteers[0];
                    finalSchedule[`${dateKey}-${type}`] = chosen;
                    counts[chosen]++;
                } else { finalSchedule[`${dateKey}-${type}`] = "UNASSIGNED"; }
            });
        }
        renderRoster();
        renderAnalytics();
    }

    function renderSelectionCalendar() {
        const cal = document.getElementById('selection-calendar');
        cal.innerHTML = "";
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
            cal.innerHTML += `<div style="font-size: 11px; font-weight: 800; color: #cbd5e1; text-transform: uppercase; padding-bottom: 8px;">${d}</div>`;
        });
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) cal.innerHTML += `<div></div>`;
        for (let d = 1; d <= totalDays; d++) {
            const date = new Date(currentYear, currentMonth, d);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const status = (allSubmissions[currentUser]?.prefs[`${currentYear}-${currentMonth}-${d}`]) || 'none';
            
            let bg = "white";
            let color = "#94a3b8";
            let tagHtml = "";
            
            if (isWeekend) bg = "#f1f5f9";
            if (status === 'early') tagHtml = `<span style="font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; background: #dbeafe; color: #1d4ed8;">AM</span>`;
            if (status === 'late') tagHtml = `<span style="font-size: 9px; font-weight: 800; padding: 2px 6px; border-radius: 4px; background: #f3e8ff; color: #7e22ce;">PM</span>`;

            const dayEl = document.createElement('div');
            dayEl.style.cssText = `height: 80px; border: 1px solid #f1f5f9; border-radius: 8px; cursor: ${isWeekend ? 'default' : 'pointer'}; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; background: ${bg};`;
            if(!isWeekend) dayEl.onclick = () => toggleShift(d);
            dayEl.innerHTML = `<span style="font-size: 12px; font-weight: 700; color: ${color};">${d}</span>${tagHtml}`;
            cal.appendChild(dayEl);
        }
    }

    function renderRoster() {
        const cal = document.getElementById('roster-calendar');
        cal.innerHTML = "";
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
            cal.innerHTML += `<div style="font-size: 11px; font-weight: 800; color: #cbd5e1; text-transform: uppercase; padding-bottom: 8px;">${d}</div>`;
        });
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const totalDays = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) cal.innerHTML += `<div></div>`;
        for (let d = 1; d <= totalDays; d++) {
            const date = new Date(currentYear, currentMonth, d);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const dateKey = `${currentYear}-${currentMonth}-${d}`;
            if (isWeekend) {
                cal.innerHTML += `<div style="height: 80px; border: 1px solid #f1f5f9; border-radius: 8px; background: #f1f5f9; opacity: 0.5; display: flex; align-items: center; justify-content: center;"><span style="font-size: 12px; font-weight: 700; color: #94a3b8;">${d}</span></div>`;
                continue;
            }
            const am = finalSchedule[`${dateKey}-early`];
            const pm = finalSchedule[`${dateKey}-late`];
            const isHighlighted = highlightedEmployee && allSubmissions[highlightedEmployee]?.prefs?.[dateKey] && allSubmissions[highlightedEmployee]?.prefs?.[dateKey] !== 'none';

            let cellStyle = `height: 80px; border: 1px solid ${isHighlighted ? '#7dd3fc' : '#f1f5f9'}; border-radius: 8px; background: ${isHighlighted ? '#e0f2fe' : 'white'}; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px;`;
            
            let html = `<div style="${cellStyle}"><span style="font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 2px;">${d}</span>`;
            html += `<span style="font-size: 8px; font-weight: 800; padding: 1px 4px; border-radius: 3px; width: 85%; white-space: nowrap; overflow: hidden; background: ${am === 'UNASSIGNED' ? '#fff' : '#dbeafe'}; color: ${am === 'UNASSIGNED' ? '#ef4444' : '#1d4ed8'}; border: ${am === 'UNASSIGNED' ? '1px solid #fee2e2' : 'none'};">AM: ${am === 'UNASSIGNED' ? '???' : am.split(' ')[0]}</span>`;
            html += `<span style="font-size: 8px; font-weight: 800; padding: 1px 4px; border-radius: 3px; width: 85%; white-space: nowrap; overflow: hidden; background: ${pm === 'UNASSIGNED' ? '#fff' : '#f3e8ff'}; color: ${pm === 'UNASSIGNED' ? '#ef4444' : '#7e22ce'}; border: ${pm === 'UNASSIGNED' ? '1px solid #fee2e2' : 'none'};">PM: ${pm === 'UNASSIGNED' ? '???' : pm.split(' ')[0]}</span>`;
            html += `</div>`;
            cal.innerHTML += html;
        }
    }

    function renderAnalytics() {
        const container = document.getElementById('chart-bars');
        if (!container) return;
        container.innerHTML = "";
        const data = EMPLOYEES.map(name => ({
            name, 
            vol: Object.values(allSubmissions[name]?.prefs || {}).filter(v => v !== 'none').length,
            ass: Object.values(finalSchedule).filter(v => v === name).length
        }));
        let maxVal = Math.max(...data.map(d => Math.max(d.vol, d.ass)), 1);
        data.forEach(d => {
            const isActive = highlightedEmployee === d.name;
            const barGroup = document.createElement('div');
            barGroup.style.cssText = `flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; cursor: pointer;`;
            barGroup.onclick = () => { highlightedEmployee = (highlightedEmployee === d.name) ? null : d.name; renderRoster(); renderAnalytics(); };
            
            barGroup.innerHTML = `
                <div style="display: flex; gap: 4px; align-items: flex-end; height: 100%; width: 100%; justify-content: center;">
                    <div style="width: 12px; background: #e0e7ff; height: ${(d.vol/maxVal)*100}%; border-radius: 2px 2px 0 0; ${isActive ? 'outline: 2px solid #4f46e5; outline-offset: 1px;' : ''}"></div>
                    <div style="width: 12px; background: #4f46e5; height: ${(d.ass/maxVal)*100}%; border-radius: 2px 2px 0 0;"></div>
                </div>
                <span style="font-size: 9px; font-weight: 700; color: ${isActive ? '#4f46e5' : '#64748b'}; margin-top: 8px; text-transform: uppercase;">${d.name.split(' ')[0]}</span>
            `;
            container.appendChild(barGroup);
        });
    }

    window.onload = init;
</script>
</body>
</html>
